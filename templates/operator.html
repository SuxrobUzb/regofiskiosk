<!DOCTYPE html>
<html>
<head>
    <title>Operator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: var(--text);
        }
        :root {
            --bg: #f4f7fa;
            --text: #2d3748;
            --card-bg: #ffffff;
            --primary: #1a73e8;
            --secondary: #34c759;
            --danger: #e53e3e;
            --border-color: #e2e8f0;
            --chat-bg-operator: #e0f2f1; /* –¶–≤–µ—Ç —Ñ–æ–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ */
            --chat-bg-user: #e3f2fd;    /* –¶–≤–µ—Ç —Ñ–æ–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */
        }
        body.dark {
            --bg: #1a202c;
            --text: #e2e8f0;
            --card-bg: #2d3748;
            --primary: #63b3ed;
            --secondary: #68d391;
            --danger: #f56565;
            --border-color: #4a5568;
            --chat-bg-operator: #4a5568;
            --chat-bg-user: #3a475a;
        }
        .container {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 24px;
            width: 100%;
            max-width: 900px; /* –£–≤–µ–ª–∏—á–µ–Ω–∞ —à–∏—Ä–∏–Ω–∞ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è —á–∞—Ç–∞ */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        h1 {
            text-align: center;
            font-size: 32px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 30px;
        }
        .info-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            flex-wrap: wrap; /* –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç–∏ */
            gap: 10px; /* –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ */
        }
        .info-item {
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
            flex-basis: auto; /* –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–º–µ—Ä */
        }
        .info-item span {
            color: var(--primary);
        }
        .actions {
            display: flex;
            flex-wrap: wrap; /* –†–∞–∑—Ä–µ—à–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å –Ω–∞ –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É */
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
        }
        .actions button, .actions select, .actions input[type="text"] {
            padding: 12px 20px;
            border-radius: 8px;
            border: none;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            white-space: nowrap; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–µ—Ä–µ–Ω–æ—Å —Ç–µ–∫—Å—Ç–∞ –Ω–∞ –∫–Ω–æ–ø–∫–∞—Ö */
        }
        .actions button {
            background: var(--primary);
            color: white;
        }
        .actions button:hover:not(:disabled) {
            background: #155bb5;
        }
        .actions button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        .actions .danger-btn {
            background: var(--danger);
        }
        .actions .danger-btn:hover:not(:disabled) {
            background: #c53030;
        }
        .actions select, .actions input[type="text"] {
            background: var(--bg);
            color: var(--text);
            border: 1px solid var(--border-color);
            padding: 10px 15px;
        }
        .actions select:focus, .actions input[type="text"]:focus {
            outline: none;
            border-color: var(--primary);
        }

        .ticket-list-section {
            margin-bottom: 30px;
        }
        .ticket-list-section h2 {
            font-size: 24px;
            color: var(--primary);
            margin-bottom: 15px;
            text-align: center;
        }
        .ticket-list-section table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .ticket-list-section th, .ticket-list-section td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
            text-align: left;
        }
        .ticket-list-section th {
            background: var(--primary);
            color: white;
            font-weight: 600;
        }
        .ticket-list-section tr:nth-child(even) {
            background: var(--bg);
        }
        .ticket-list-section tr:hover {
            background: #e9ecef;
        }
        body.dark .ticket-list-section tr:hover {
            background: #3a475a;
        }
        .called-ticket {
            background-color: var(--secondary) !important;
            color: white;
            font-weight: bold;
        }

        /* Chat Section Styles */
        .chat-section {
            background: var(--bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            padding: 15px;
            margin-top: 20px;
            display: none; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ç–∞–ª–æ–Ω–∞ */
            flex-direction: column;
            height: 400px; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è —á–∞—Ç–∞ */
        }
        .chat-section h2 {
            font-size: 22px;
            color: var(--primary);
            margin-bottom: 15px;
            text-align: center;
        }
        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
        }
        .chat-message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 15px;
            max-width: 80%;
            word-wrap: break-word;
        }
        .chat-message.user {
            background-color: var(--chat-bg-user);
            margin-right: auto;
            border-bottom-left-radius: 2px;
        }
        .chat-message.operator {
            background-color: var(--chat-bg-operator);
            margin-left: auto;
            border-bottom-right-radius: 2px;
        }
        .chat-message strong {
            font-size: 14px;
            display: block;
            margin-bottom: 3px;
        }
        .chat-input-form {
            display: flex;
            gap: 10px;
        }
        .chat-input-form input[type="text"] {
            flex-grow: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text);
        }
        .chat-input-form button {
            padding: 10px 15px;
            background: var(--primary);
            color: white;
            border-radius: 8px;
            border: none;
            cursor: pointer;
        }
        .chat-input-form button:hover {
            background: #155bb5;
        }

        /* Notifications */
        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        .notification.show {
            opacity: 1;
        }

        /* Language and Theme switchers */
        .lang-switcher, .theme-switcher {
            position: absolute;
            top: 20px;
            display: flex;
            gap: 10px;
        }
        .lang-switcher { left: 20px; }
        .theme-switcher { right: 20px; }
        .lang-btn, .theme-toggle {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }
        .lang-btn:hover, .theme-toggle:hover {
            background: #155bb5;
        }
        .lang-btn.active {
            background: var(--secondary);
        }

        /* Daily Stats Section */
        .stats-section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            width: 100%;
            max-width: 900px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: left;
            margin-top: 20px;
            border: 1px solid var(--border-color);
        }
        .stats-section h2 {
            font-size: 24px;
            color: var(--primary);
            margin-bottom: 20px;
            text-align: center;
        }
        .stats-item {
            font-size: 18px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .stats-item strong {
            color: var(--text);
        }
        .stats-item span {
            color: var(--primary);
            font-weight: 600;
        }


        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container, .stats-section {
                padding: 15px;
                max-width: 90%; /* –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è —à–∏—Ä–∏–Ω–∞ */
            }
            h1 {
                font-size: 28px;
            }
            .info-section {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .actions {
                flex-direction: column;
                gap: 10px;
            }
            .actions button, .actions select, .actions input[type="text"] {
                width: 100%;
            }
            .lang-switcher, .theme-switcher {
                position: static;
                margin-bottom: 20px;
                justify-content: center;
                width: 100%;
            }
            .stats-item {
                flex-direction: column; /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤ —Å—Ç–æ–ª–±–µ—Ü –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
                align-items: flex-start;
            }
            .stats-item strong, .stats-item span {
                width: 100%;
                text-align: left;
            }
        }
    </style>
</head>
<body>
    <div class="lang-switcher">
        <button class="lang-btn active" onclick="setLanguage('uz_lat')">UZ</button>
        <button class="lang-btn" onclick="setLanguage('ru')">RU</button>
        <button class="lang-btn" onclick="setLanguage('en')">EN</button>
    </div>
    <div class="theme-switcher">
        <button class="theme-toggle" onclick="toggleTheme()">üåô</button>
    </div>

    <h1><span id="pageTitle">Operator</span></h1>

    <div class="container">
        <!-- –û–ø–µ—Ä–∞—Ç–æ—Ä –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ–∫—É—â–µ–º —Ç–∞–ª–æ–Ω–µ -->
        <div class="info-section">
            <div class="info-item">
                <span id="operatorNameDisplay">Operator: </span>
                <span id="operatorNumberDisplay">‚Ññ: </span>
            </div>
            <div class="info-item">
                <span id="telegramIdDisplay">Telegram ID: </span>
                <span id="telegramIdValue">N/A</span>
            </div>
            <div class="info-item">
                <span id="currentTicketLabel">Joriy Talon: </span>
                <span id="ticket_number">Kutilmoqda</span>
            </div>
            <button onclick="logout()" class="danger-btn" id="logoutButton">Chiqish</button>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
        <div class="actions">
            <button onclick="callNextTicket()" id="callButton">Keyingi mijozni chaqirish</button>
            <button onclick="finishTicket()" id="finishButton">Talonni yakunlash</button>
            <button onclick="showRedirectOptions()" id="redirectButton">Talonni yo'naltirish</button>
            <div id="redirectOptions" style="display: none; gap: 10px; flex-wrap: wrap; justify-content: center;">
                <select id="redirectOperatorSelect">
                    <option value="">Operator tanlang</option>
                </select>
                <select id="redirectServiceSelect">
                    <option value="">Xizmat tanlang</option>
                </select>
                <button onclick="confirmRedirect()" id="confirmRedirectButton">Tasdiqlash</button>
                <button onclick="cancelRedirect()" class="danger-btn" id="cancelRedirectButton">Bekor qilish</button>
            </div>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ —Ç–∞–ª–æ–Ω–æ–≤ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ -->
        <div class="ticket-list-section">
            <h2 id="queueListTitle">Navbatdagi Talonlar Ro'yxati</h2>
            <table id="ticketTable">
                <thead>
                    <tr>
                        <th id="thTickets">Talon</th>
                        <th id="thService">Xizmat</th>
                        <th id="thStatus">Holat</th>
                        <th id="thActions">Harakatlar</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Ticket list will be loaded here -->
                </tbody>
            </table>
        </div>

        <!-- –†–∞–∑–¥–µ–ª —á–∞—Ç–∞ -->
        <div class="chat-section" id="chatSection">
            <h2 id="chatHeader">Suhbat - Talon: <span id="chatTicketNumber"></span></h2>
            <div class="chat-messages" id="chatMessages">
                <!-- Chat messages will be loaded here -->
            </div>
            <form class="chat-input-form" id="chatInputForm">
                <input type="text" id="chatMessageInput" placeholder="Xabar yozing..." autocomplete="off">
                <button type="submit" id="sendChatMessageButton">Yuborish</button>
            </form>
        </div>
    </div>

    <!-- –†–∞–∑–¥–µ–ª –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (–ü–ï–†–ï–ú–ï–©–ï–ù–û –ò–ó TABLET.HTML) -->
    <div class="stats-section">
        <h2 id="dailyStatsTitle">Kunlik statistika</h2>
        <div class="stats-item">
            <strong id="ticketsFinishedLabel">Obushennye talony:</strong> <span id="ticketsFinished">0</span>
        </div>
        <div class="stats-item">
            <strong id="avgServiceTimeLabel">O'rtacha xizmat ko'rsatish vaqti:</strong> <span id="avgServiceTime">N/A</span>
        </div>
        <div class="stats-item">
            <strong id="feedbackCountLabel">Olingan fikr-mulohazalar:</strong> <span id="feedbackCount">0</span>
        </div>
        <div class="stats-item">
            <strong id="avgRatingLabel">O'rtacha reyting:</strong> <span id="avgRating">N/A</span>
        </div>
        <div class="stats-item">
            <strong id="disputeCountLabel">Olingan shikoyatlar:</strong> <span id="disputeCount">0</span>
        </div>
    </div>

    <!-- Notification element -->
    <div class="notification" id="notification"></div>

    <script>
        const serverUrl = '{{ server_url }}';
        const operatorId = {{ operator_id }}; // –ü–æ–ª—É—á–∞–µ–º ID –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –∏–∑ Flask
        const operatorName = "{{ session['operator_name'] }}"; // –ü–æ–ª—É—á–∞–µ–º –∏–º—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –∏–∑ Flask

        let currentTicketId = null; // –¢–µ–∫—É—â–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–∞–ª–æ–Ω, —Å –∫–æ—Ç–æ—Ä—ã–º —Ä–∞–±–æ—Ç–∞–µ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä
        let operatorTelegramId = null; // –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è Telegram ID –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
        let availableOperators = []; // –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –¥–ª—è –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        let availableServices = []; // –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É—Å–ª—É–≥ –¥–ª—è –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è

        const socket = io(serverUrl);

        // –ü–µ—Ä–µ–≤–æ–¥—ã
        const translations = {
            uz_lat: {
                page_title: "Operator",
                operator: "Operator:",
                operator_num: "‚Ññ:",
                telegram_id: "Telegram ID:",
                current_ticket: "Joriy Talon:",
                waiting: "Kutilmoqda",
                call_next: "Keyingi mijozni chaqirish",
                finish_ticket: "Talonni yakunlash",
                redirect_ticket: "Talonni yo'naltirish",
                select_operator: "Operator tanlang",
                select_service: "Xizmat tanlang",
                confirm: "Tasdiqlash",
                cancel: "Bekor qilish",
                logout: "Chiqish",
                queue_list_title: "Navbatdagi Talonlar Ro'yxati",
                tickets: "Talon",
                service: "Xizmat",
                status: "Holat",
                actions: "Harakatlar",
                chat_header: "Suhbat - Talon:",
                send_message_placeholder: "Xabar yozing...",
                send: "Yuborish",
                message_sent: "Xabar yuborildi.",
                ticket_called_success: "Talon chaqirildi:",
                ticket_finished_success: "Talon yakunlandi:",
                ticket_redirect_success: "Talon yo'naltirildi:",
                error_fetch: "Ma'lumotlarni yuklashda xato:",
                error_call: "Talonni chaqirishda xato:",
                error_finish: "Talonni yakunlashda xato:",
                error_redirect: "Talonni yo'naltirishda xato:",
                error_send_chat: "Xabar yuborishda xato:",
                no_active_ticket: "Faol talon tanlanmagan.",
                confirm_logout: "Chiqishni tasdiqlaysizmi?",
                daily_stats_title: "Kunlik statistika",
                tickets_finished: "Obushennye talony:",
                avg_service_time: "O'rtacha xizmat ko'rsatish vaqti:",
                feedback_count: "Olingan fikr-mulohazalar:",
                avg_rating: "O'rtacha reyting:",
                dispute_count: "Olingan shikoyatlar:"
            },
            ru: {
                page_title: "–û–ø–µ—Ä–∞—Ç–æ—Ä",
                operator: "–û–ø–µ—Ä–∞—Ç–æ—Ä:",
                operator_num: "‚Ññ:",
                telegram_id: "Telegram ID:",
                current_ticket: "–¢–µ–∫—É—â–∏–π –¢–∞–ª–æ–Ω:",
                waiting: "–û–∂–∏–¥–∞–Ω–∏–µ",
                call_next: "–í—ã–∑–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞",
                finish_ticket: "–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–∞–ª–æ–Ω",
                redirect_ticket: "–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å —Ç–∞–ª–æ–Ω",
                select_operator: "–í—ã–±–µ—Ä–∏—Ç–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞",
                select_service: "–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É",
                confirm: "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å",
                cancel: "–û—Ç–º–µ–Ω–∞",
                logout: "–í—ã–π—Ç–∏",
                queue_list_title: "–°–ø–∏—Å–æ–∫ –¢–∞–ª–æ–Ω–æ–≤ –≤ –û—á–µ—Ä–µ–¥–∏",
                tickets: "–¢–∞–ª–æ–Ω",
                service: "–£—Å–ª—É–≥–∞",
                status: "–°—Ç–∞—Ç—É—Å",
                actions: "–î–µ–π—Å—Ç–≤–∏—è",
                chat_header: "–ß–∞—Ç - –¢–∞–ª–æ–Ω:",
                send_message_placeholder: "–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...",
                send: "–û—Ç–ø—Ä–∞–≤–∏—Ç—å",
                message_sent: "–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.",
                ticket_called_success: "–¢–∞–ª–æ–Ω –≤—ã–∑–≤–∞–Ω:",
                ticket_finished_success: "–¢–∞–ª–æ–Ω –∑–∞–≤–µ—Ä—à–µ–Ω:",
                ticket_redirect_success: "–¢–∞–ª–æ–Ω –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω:",
                error_fetch: "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:",
                error_call: "–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ —Ç–∞–ª–æ–Ω–∞:",
                error_finish: "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Ç–∞–ª–æ–Ω–∞:",
                error_redirect: "–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ —Ç–∞–ª–æ–Ω–∞:",
                error_send_chat: "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è:",
                no_active_ticket: "–ê–∫—Ç–∏–≤–Ω—ã–π —Ç–∞–ª–æ–Ω –Ω–µ –≤—ã–±—Ä–∞–Ω.",
                confirm_logout: "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?",
                daily_stats_title: "–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞",
                tickets_finished: "–û–±—Å–ª—É–∂–µ–Ω–æ —Ç–∞–ª–æ–Ω–æ–≤:",
                avg_service_time: "–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è:",
                feedback_count: "–ü–æ–ª—É—á–µ–Ω–æ –æ—Ç–∑—ã–≤–æ–≤:",
                avg_rating: "–°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥:",
                dispute_count: "–ü–æ–ª—É—á–µ–Ω–æ –∂–∞–ª–æ–±:"
            },
            en: {
                page_title: "Operator",
                operator: "Operator:",
                operator_num: "No.:",
                telegram_id: "Telegram ID:",
                current_ticket: "Current Ticket:",
                waiting: "Waiting",
                call_next: "Call Next Client",
                finish_ticket: "Finish Ticket",
                redirect_ticket: "Redirect Ticket",
                select_operator: "Select Operator",
                select_service: "Select Service",
                confirm: "Confirm",
                cancel: "Cancel",
                logout: "Logout",
                queue_list_title: "Ticket Queue List",
                tickets: "Ticket",
                service: "Service",
                status: "Status",
                actions: "Actions",
                chat_header: "Chat - Ticket:",
                send_message_placeholder: "Type a message...",
                send: "Send",
                message_sent: "Message sent.",
                ticket_called_success: "Ticket called:",
                ticket_finished_success: "Ticket finished:",
                ticket_redirect_success: "Ticket redirected:",
                error_fetch: "Error fetching data:",
                error_call: "Error calling ticket:",
                error_finish: "Error finishing ticket:",
                error_redirect: "Error redirecting ticket:",
                error_send_chat: "Error sending message:",
                no_active_ticket: "No active ticket selected.",
                confirm_logout: "Are you sure you want to log out?",
                daily_stats_title: "Daily Statistics",
                tickets_finished: "Tickets Finished:",
                avg_service_time: "Average Service Time:",
                feedback_count: "Feedback Received:",
                avg_rating: "Average Rating:",
                dispute_count: "Disputes Received:"
            }
        };
        let currentLang = 'uz_lat';

        // --- –£—Ç–∏–ª–∏—Ç—ã ---
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.innerText = message;
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // --- –§—É–Ω–∫—Ü–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö ---
        async function fetchOperatorDetails() {
            try {
                // –î–æ–±–∞–≤–ª—è–µ–º —ç–Ω–¥–ø–æ–∏–Ω—Ç –≤ app.py, –∫–æ—Ç–æ—Ä—ã–π –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–µ—Ç–∞–ª–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞, –≤–∫–ª—é—á–∞—è telegram_chat_id
                const response = await fetch(`${serverUrl}/api/operator_details/${operatorId}`);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const data = await response.json();
                document.getElementById('operatorNameDisplay').innerText = `${translations[currentLang].operator} ${data.name}`;
                document.getElementById('operatorNumberDisplay').innerText = `${translations[currentLang].operator_num} ${data.operator_number}`;
                operatorTelegramId = data.telegram_chat_id || translations[currentLang].waiting;
                document.getElementById('telegramIdValue').innerText = operatorTelegramId;
            } catch (error) {
                console.error("Error fetching operator details:", error);
                showNotification(`${translations[currentLang].error_fetch} ${error.message}`);
            }
        }

        async function fetchAvailableOperators() {
            try {
                // –ù–æ–≤—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç –≤ app.py, –∫–æ—Ç–æ—Ä—ã–π –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤
                const response = await fetch(`${serverUrl}/api/get_all_operators`);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                availableOperators = await response.json();
                const select = document.getElementById('redirectOperatorSelect');
                select.innerHTML = `<option value="">${translations[currentLang].select_operator}</option>`;
                availableOperators.forEach(op => {
                    if (op.id !== operatorId) { // –ù–µ –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å–∞–º–æ–≥–æ —Å–µ–±—è
                        const option = document.createElement('option');
                        option.value = op.id;
                        option.innerText = op.name;
                        select.appendChild(option);
                    }
                });
            } catch (error) {
                console.error("Error fetching operators:", error);
                showNotification(`${translations[currentLang].error_fetch} ${error.message}`);
            }
        }

        async function fetchAvailableServices() {
            try {
                const response = await fetch(`${serverUrl}/get_categories`); // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è —É—Å–ª—É–≥
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const services = await response.json();
                const select = document.getElementById('redirectServiceSelect');
                select.innerHTML = `<option value="">${translations[currentLang].select_service}</option>`;
                availableServices.forEach(svc => {
                    const option = document.createElement('option');
                    option.value = svc.id;
                    option.innerText = svc.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error("Error fetching services:", error);
                showNotification(`${translations[currentLang].error_fetch} ${error.message}`);
            }
        }

        async function updateTicketList() {
            try {
                const response = await fetch(`${serverUrl}/operator/${operatorId}/tickets`);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const tickets = await response.json();
                const tableBody = document.querySelector("#ticketTable tbody");
                tableBody.innerHTML = '';

                let foundCalledTicket = false;
                tickets.forEach(ticket => {
                    const row = document.createElement("tr");
                    if (ticket.status === "called") {
                        row.classList.add("called-ticket");
                        if (!foundCalledTicket) {
                            currentTicketId = ticket.number;
                            document.getElementById("ticket_number").innerText = ticket.number;
                            foundCalledTicket = true;
                            showChatForTicket(ticket.number); // –ü–æ–∫–∞–∑–∞—Ç—å —á–∞—Ç –¥–ª—è –≤—ã–∑–≤–∞–Ω–Ω–æ–≥–æ —Ç–∞–ª–æ–Ω–∞
                        }
                    }
                    row.innerHTML = `
                        <td>${ticket.number}</td>
                        <td>${ticket.service_name || 'N/A'}</td>
                        <td>${ticket.status}</td>
                        <td>
                            <button class="call-ticket-btn primary-btn" data-ticket-id="${ticket.number}" style="display:${ticket.status === 'waiting' ? 'inline-block' : 'none'}">${translations[currentLang].call_next}</button>
                            <button class="finish-ticket-btn secondary-btn" data-ticket-id="${ticket.number}" style="display:${ticket.status === 'called' ? 'inline-block' : 'none'}">${translations[currentLang].finish_ticket}</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });

                // –ü—Ä–∏–∫—Ä–µ–ø–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª–∏ –∫ –∫–Ω–æ–ø–∫–∞–º –≤—ã–∑–æ–≤–∞ –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
                document.querySelectorAll('.call-ticket-btn').forEach(button => {
                    button.onclick = (event) => callTicket(event.target.dataset.ticketId);
                });
                document.querySelectorAll('.finish-ticket-btn').forEach(button => {
                    button.onclick = (event) => finishTicket(event.target.dataset.ticketId);
                });

                if (!foundCalledTicket) {
                    document.getElementById("ticket_number").innerText = translations[currentLang].waiting;
                    currentTicketId = null;
                    hideChatSection(); // –°–∫—Ä—ã—Ç—å —á–∞—Ç, –µ—Å–ª–∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ç–∞–ª–æ–Ω–∞
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π
                const callButton = document.getElementById('callButton');
                const finishButton = document.getElementById('finishButton');
                const redirectButton = document.getElementById('redirectButton');

                callButton.disabled = foundCalledTicket || tickets.filter(t => t.status === 'waiting').length === 0;
                finishButton.disabled = !foundCalledTicket;
                redirectButton.disabled = !foundCalledTicket;

            } catch (error) {
                console.error("Error updating ticket list:", error);
                showNotification(`${translations[currentLang].error_fetch} ${error.message}`);
            }
        }

        async function fetchDailyStats() {
            try {
                // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ app.py –∏–º–µ–µ—Ç —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
                const today = new Date().toISOString().slice(0, 10); // 'YYYY-MM-DD'
                const response = await fetch(`${serverUrl}/api/operator_daily_stats/${operatorId}?date=${today}`);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const stats = await response.json();

                document.getElementById('ticketsFinished').innerText = stats.finished_tickets_count || 0;
                document.getElementById('avgServiceTime').innerText = stats.avg_service_time !== null ? `${stats.avg_service_time.toFixed(2)} ${translations[currentLang].avg_service_time.includes('–≤—Ä–µ–º—è') ? '–º–∏–Ω—É—Ç' : 'daqiqalar'}` : 'N/A';
                document.getElementById('feedbackCount').innerText = stats.feedback_count || 0;
                document.getElementById('avgRating').innerText = stats.avg_rating !== null ? stats.avg_rating.toFixed(2) : 'N/A';
                document.getElementById('disputeCount').innerText = stats.disputes_count || 0;

            } catch (error) {
                console.error("Error fetching daily stats:", error);
                showNotification(`${translations[currentLang].error_fetch} ${error.message}`);
            }
        }

        // --- –§—É–Ω–∫—Ü–∏–∏ –¥–µ–π—Å—Ç–≤–∏–π —Å —Ç–∞–ª–æ–Ω–∞–º–∏ ---
        async function callTicket(ticketNumber = null) {
            let targetTicket = ticketNumber;
            if (!targetTicket) { // –ï—Å–ª–∏ –≤—ã–∑–æ–≤ –±–µ–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–∞–ª–æ–Ω–∞, –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π "waiting"
                const response = await fetch(`${serverUrl}/operator/${operatorId}/tickets`);
                const tickets = await response.json();
                const waitingTickets = tickets.filter(t => t.status === 'waiting');
                if (waitingTickets.length > 0) {
                    targetTicket = waitingTickets[0].number;
                } else {
                    showNotification(translations[currentLang].no_active_ticket);
                    return;
                }
            }

            try {
                const response = await fetch(`${serverUrl}/call_ticket`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ticket: targetTicket, operator_id: operatorId })
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
                }
                showNotification(`${translations[currentLang].ticket_called_success} ${targetTicket}`);
                updateTicketList(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Ç–∞–ª–æ–Ω–æ–≤ –ø–æ—Å–ª–µ –≤—ã–∑–æ–≤–∞
                fetchDailyStats(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            } catch (error) {
                console.error("Error calling ticket:", error);
                showNotification(`${translations[currentLang].error_call} ${error.message}`);
            }
        }

        async function finishTicket(ticketNumber = null) {
            const ticketToFinish = ticketNumber || currentTicketId;
            if (!ticketToFinish) {
                showNotification(translations[currentLang].no_active_ticket);
                return;
            }

            try {
                const response = await fetch(`${serverUrl}/finish_ticket`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ticket: ticketToFinish, operator_id: operatorId })
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
                }
                showNotification(`${translations[currentLang].ticket_finished_success} ${ticketToFinish}`);
                updateTicketList(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Ç–∞–ª–æ–Ω–æ–≤ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
                fetchDailyStats(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                hideChatSection(); // –°–∫—Ä—ã–≤–∞–µ–º —á–∞—Ç
            } catch (error) {
                console.error("Error finishing ticket:", error);
                showNotification(`${translations[currentLang].error_finish} ${error.message}`);
            }
        }

        function showRedirectOptions() {
            if (!currentTicketId) {
                showNotification(translations[currentLang].no_active_ticket);
                return;
            }
            document.getElementById('redirectButton').style.display = 'none';
            document.getElementById('redirectOptions').style.display = 'flex';
            fetchAvailableOperators();
            fetchAvailableServices();
        }

        async function confirmRedirect() {
            const toOperatorId = document.getElementById('redirectOperatorSelect').value;
            const toServiceId = document.getElementById('redirectServiceSelect').value;

            if (!toOperatorId && !toServiceId) {
                showNotification("–í—ã–±–µ—Ä–∏—Ç–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –∏–ª–∏ —É—Å–ª—É–≥—É –¥–ª—è –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è.");
                return;
            }

            if (!currentTicketId) {
                showNotification(translations[currentLang].no_active_ticket);
                return;
            }

            try {
                const response = await fetch(`${serverUrl}/redirect_ticket`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        ticket: currentTicketId, 
                        operator_id: operatorId, 
                        to_operator_id: toOperatorId || null, 
                        to_service_id: toServiceId || null 
                    })
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
                }
                showNotification(`${translations[currentLang].ticket_redirect_success} ${currentTicketId}`);
                cancelRedirect(); // –°–∫—Ä—ã—Ç—å –æ–ø—Ü–∏–∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                updateTicketList(); // –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ç–∞–ª–æ–Ω–æ–≤
                fetchDailyStats(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                hideChatSection(); // –°–∫—Ä—ã—Ç—å —á–∞—Ç
            } catch (error) {
                console.error("Error redirecting ticket:", error);
                showNotification(`${translations[currentLang].error_redirect} ${error.message}`);
            }
        }

        function cancelRedirect() {
            document.getElementById('redirectButton').style.display = 'inline-block';
            document.getElementById('redirectOptions').style.display = 'none';
            document.getElementById('redirectOperatorSelect').value = '';
            document.getElementById('redirectServiceSelect').value = '';
        }

        function logout() {
            if (confirm(translations[currentLang].confirm_logout)) {
                window.location.href = `${serverUrl}/logout`;
            }
        }

        // --- –§—É–Ω–∫—Ü–∏–∏ —á–∞—Ç–∞ ---
        function showChatForTicket(ticketId) {
            document.getElementById('chatSection').style.display = 'flex';
            document.getElementById('chatTicketNumber').innerText = ticketId;
            loadChatHistory(ticketId);
            // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ SocketIO –¥–ª—è —ç—Ç–æ–≥–æ —Ç–∞–ª–æ–Ω–∞
            socket.emit('join', { room: ticketId });
        }

        function hideChatSection() {
            document.getElementById('chatSection').style.display = 'none';
            document.getElementById('chatTicketNumber').innerText = '';
            document.getElementById('chatMessages').innerHTML = ''; // –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞
            // –ú–æ–∂–Ω–æ –≤—ã–π—Ç–∏ –∏–∑ –∫–æ–º–Ω–∞—Ç—ã SocketIO, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
            // socket.emit('leave', { room: currentTicketId });
        }

        async function loadChatHistory(ticketId) {
            try {
                const response = await fetch(`${serverUrl}/get_chat_history/${ticketId}`);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const messages = await response.json();
                const chatMessagesDiv = document.getElementById('chatMessages');
                chatMessagesDiv.innerHTML = '';
                messages.forEach(msg => {
                    displayChatMessage(msg.sender_type, msg.content);
                });
                chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight; // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
            } catch (error) {
                console.error("Error loading chat history:", error);
                showNotification(`${translations[currentLang].error_fetch} ${error.message}`);
            }
        }

        function displayChatMessage(senderType, content) {
            const chatMessagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${senderType}`;
            messageDiv.innerHTML = `<strong>${senderType === 'user' ? '–ö–ª–∏–µ–Ω—Ç' : '–í—ã'}:</strong> ${content}`;
            chatMessagesDiv.appendChild(messageDiv);
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight; // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
        }

        document.getElementById('chatInputForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const messageInput = document.getElementById('chatMessageInput');
            const messageContent = messageInput.value.trim();

            if (messageContent && currentTicketId) {
                try {
                    const response = await fetch(`${serverUrl}/send_chat_message`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ticket_id: currentTicketId,
                            sender_type: 'operator',
                            content: messageContent
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
                    }
                    displayChatMessage('operator', messageContent); // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    messageInput.value = ''; // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
                    showNotification(translations[currentLang].message_sent);
                } catch (error) {
                    console.error("Error sending chat message:", error);
                    showNotification(`${translations[currentLang].error_send_chat} ${error.message}`);
                }
            } else if (!currentTicketId) {
                showNotification(translations[currentLang].no_active_ticket);
            }
        });

        // --- SocketIO Listeners ---
        socket.on('connect', () => {
            console.log('Connected to SocketIO server');
            // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∞—Ç—å –æ–±—â–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            socket.emit('join', { room: `operator_${operatorId}` }); 
            // –¢–∞–∫–∂–µ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ç–∞–ª–æ–Ω–∞, –µ—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π
            if (currentTicketId) {
                socket.emit('join', { room: currentTicketId });
            }
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from SocketIO server');
            showNotification("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º –ø–æ—Ç–µ—Ä—è–Ω–æ.");
        });

        socket.on('chat_message', (data) => {
            // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —á–∞—Ç–∞
            if (data.ticket_id === currentTicketId && data.sender !== 'operator') { // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–≤–æ–∏ –∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                displayChatMessage(data.sender, data.content);
                // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∑–≤—É–∫–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–æ–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
            }
        });

        socket.on('ticket_called', (data) => {
            // –ï—Å–ª–∏ —Ç–∞–ª–æ–Ω, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–∑–≤–∞–Ω, –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ —ç—Ç–æ–º—É –æ–ø–µ—Ä–∞—Ç–æ—Ä—É
            if (data.operator_id === operatorId) {
                showNotification(`${translations[currentLang].ticket_called_success} ${data.ticket}`);
            }
            updateTicketList(); // –í—Å–µ–≥–¥–∞ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
            fetchDailyStats(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        });

        socket.on('ticket_finished', (data) => {
            if (data.operator_id === operatorId) {
                showNotification(`${translations[currentLang].ticket_finished_success} ${data.ticket}`);
            }
            updateTicketList();
            fetchDailyStats();
        });

        socket.on('ticket_redirected', (data) => {
            // –£–≤–µ–¥–æ–º–ª—è–µ–º, –µ—Å–ª–∏ —Ç–∞–ª–æ–Ω –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω –æ—Ç –∏–ª–∏ –∫ —ç—Ç–æ–º—É –æ–ø–µ—Ä–∞—Ç–æ—Ä—É
            showNotification(`–¢–∞–ª–æ–Ω ${data.ticket} –±—ã–ª –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω.`);
            updateTicketList();
            fetchDailyStats();
        });

        socket.on('new_feedback', (data) => {
            // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–æ–≤–æ–º –æ—Ç–∑—ã–≤–µ
            showNotification(`–ù–æ–≤—ã–π –æ—Ç–∑—ã–≤ –¥–ª—è —Ç–∞–ª–æ–Ω–∞ ${data.ticket_id}! –†–µ–π—Ç–∏–Ω–≥: ${data.rating}`);
        });

        socket.on('new_dispute', (data) => {
            // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–æ–≤–æ–π –∂–∞–ª–æ–±–µ
            showNotification(`–ù–æ–≤–∞—è –∂–∞–ª–æ–±–∞ –¥–ª—è —Ç–∞–ª–æ–Ω–∞ ${data.ticket_id}!`);
        });

        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ —Å–º–µ–Ω–∞ —è–∑—ã–∫–∞/—Ç–µ–º—ã ---
        function setLanguage(lang) {
            currentLang = lang;
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`button[onclick="setLanguage('${lang}')"]`).classList.add('active');

            document.getElementById('pageTitle').innerText = translations[lang].page_title;
            document.getElementById('operatorNameDisplay').innerText = `${translations[lang].operator} ${operatorName}`;
            document.getElementById('operatorNumberDisplay').innerText = `${translations[lang].operator_num} ${operatorId}`;
            document.getElementById('telegramIdDisplay').innerText = translations[lang].telegram_id;
            document.getElementById('telegramIdValue').innerText = operatorTelegramId || translations[lang].waiting;
            document.getElementById('currentTicketLabel').innerText = translations[lang].current_ticket;
            document.getElementById('ticket_number').innerText = currentTicketId || translations[lang].waiting;
            document.getElementById('logoutButton').innerText = translations[lang].logout;

            document.getElementById('callButton').innerText = translations[lang].call_next;
            document.getElementById('finishButton').innerText = translations[lang].finish_ticket;
            document.getElementById('redirectButton').innerText = translations[lang].redirect_ticket;
            document.getElementById('redirectOperatorSelect').querySelector('option[value=""]').innerText = translations[lang].select_operator;
            document.getElementById('redirectServiceSelect').querySelector('option[value=""]').innerText = translations[lang].select_service;
            document.getElementById('confirmRedirectButton').innerText = translations[lang].confirm;
            document.getElementById('cancelRedirectButton').innerText = translations[lang].cancel;

            document.getElementById('queueListTitle').innerText = translations[lang].queue_list_title;
            document.getElementById('thTickets').innerText = translations[lang].tickets;
            document.getElementById('thService').innerText = translations[lang].service;
            document.getElementById('thStatus').innerText = translations[lang].status;
            document.getElementById('thActions').innerText = translations[lang].actions;

            document.getElementById('chatHeader').innerText = `${translations[lang].chat_header} ${currentTicketId || ''}`;
            document.getElementById('chatMessageInput').placeholder = translations[lang].send_message_placeholder;
            document.getElementById('sendChatMessageButton').innerText = translations[lang].send;

            // –û–±–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—Å—Ç—ã –∫–Ω–æ–ø–æ–∫ –≤ —Ç–∞–±–ª–∏—Ü–µ
            document.querySelectorAll('.call-ticket-btn').forEach(btn => btn.innerText = translations[lang].call_next);
            document.querySelectorAll('.finish-ticket-btn').forEach(btn => btn.innerText = translations[lang].finish_ticket);

            // –†–∞–∑–¥–µ–ª —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            document.getElementById('dailyStatsTitle').innerText = translations[lang].daily_stats_title;
            document.getElementById('ticketsFinishedLabel').innerText = translations[lang].tickets_finished;
            document.getElementById('avgServiceTimeLabel').innerText = translations[lang].avg_service_time;
            document.getElementById('feedbackCountLabel').innerText = translations[lang].feedback_count;
            document.getElementById('avgRatingLabel').innerText = translations[lang].avg_rating;
            document.getElementById('disputeCountLabel').innerText = translations[lang].dispute_count;


            updateTicketList(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫, —á—Ç–æ–±—ã –ø—Ä–∏–º–µ–Ω–∏—Ç—å –ø–µ—Ä–µ–≤–æ–¥—ã –∫ —Å—Ç–∞—Ç—É—Å–∞–º
            fetchDailyStats(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É, —á—Ç–æ–±—ã –ø–µ—Ä–µ–≤–µ–ª–∏—Å—å –µ–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è –∏ N/A
        }

        function toggleTheme() {
            document.body.classList.toggle('dark');
            const isDark = document.body.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            document.querySelector('.theme-toggle').innerText = isDark ? '‚òÄÔ∏è' : 'üåô';
        }

        // –í—ã–∑–æ–≤—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        if (localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark');
            document.querySelector('.theme-toggle').innerText = '‚òÄÔ∏è';
        }

        setLanguage('uz_lat'); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —è–∑—ã–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        fetchOperatorDetails(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
        updateTicketList(); // –ü–µ—Ä–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ç–∞–ª–æ–Ω–æ–≤
        fetchDailyStats(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –µ–∂–µ–¥–Ω–µ–≤–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        setInterval(updateTicketList, 5000); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
        setInterval(fetchDailyStats, 10000); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
    </script>
</body>
</html>
