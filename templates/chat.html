<!DOCTYPE html>
<html>
<head>
    <title>Chat with Operator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
        /* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            transition: background 0.3s ease, color 0.3s ease;
        }

        /* –¶–≤–µ—Ç–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Å–≤–µ—Ç–ª–æ–π —Ç–µ–º—ã */
        :root {
            --bg: #f4f7fa;
            --text: #2d3748;
            --card-bg: #ffffff;
            --primary: #1a73e8; /* –û—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç */
            --secondary: #34c759; /* –í—Ç–æ—Ä–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–π/—É—Å–ø–µ—à–Ω—ã–π —Ü–≤–µ—Ç */
            --danger: #e53e3e; /* –¶–≤–µ—Ç –¥–ª—è –æ—à–∏–±–æ–∫/–æ–ø–∞—Å–Ω–æ—Å—Ç–µ–π */
            --border-color: #e2e8f0;
            --chat-bg-client: #e3f2fd; /* –¶–≤–µ—Ç —Ñ–æ–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∫–ª–∏–µ–Ω—Ç–∞ */
            --chat-bg-operator: #e0f2f1; /* –¶–≤–µ—Ç —Ñ–æ–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ */
            --input-bg: #edf2f7;
            --input-border: #cbd5e0;
            --button-hover: #1666c5;
        }

        /* –¶–≤–µ—Ç–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã */
        body.dark {
            --bg: #1a202c;
            --text: #e2e8f0;
            --card-bg: #2d3748;
            --primary: #63b3ed;
            --secondary: #68d391;
            --danger: #f56565;
            --border-color: #4a5568;
            --chat-bg-client: #3c548a;
            --chat-bg-operator: #4a5568;
            --input-bg: #2d3748;
            --input-border: #4a5568;
            --button-hover: #4299e1;
        }

        .container {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 24px;
            width: 100%;
            max-width: 700px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 20px;
            position: relative;
            animation: fadeIn 0.5s ease-out;
            height: calc(100vh - 40px); /* –£—á–∏—Ç—ã–≤–∞–µ–º padding body */
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            font-size: clamp(22px, 4vw, 32px);
            font-weight: 600;
            color: var(--primary);
            text-align: center;
        }

        .chat-box {
            flex-grow: 1;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            overflow-y: auto;
            background: var(--bg); /* –§–æ–Ω –¥–ª—è –æ–±–ª–∞—Å—Ç–∏ —á–∞—Ç–∞ */
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .message {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 15px;
            word-wrap: break-word;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            font-size: 15px;
            line-height: 1.4;
        }

        .message.client {
            background-color: var(--chat-bg-client);
            color: var(--text);
            align-self: flex-end; /* –°–æ–æ–±—â–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞ —Å–ø—Ä–∞–≤–∞ */
            border-bottom-right-radius: 5px;
        }

        .message.operator {
            background-color: var(--chat-bg-operator);
            color: var(--text);
            align-self: flex-start; /* –°–æ–æ–±—â–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ —Å–ª–µ–≤–∞ */
            border-bottom-left-radius: 5px;
        }
        
        .message-timestamp {
            font-size: 10px;
            color: var(--text-light);
            margin-top: 5px;
            text-align: right;
            display: block;
        }

        .message.operator .message-timestamp {
            text-align: left;
        }

        .chat-input {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .chat-input input[type="text"] {
            flex-grow: 1;
            padding: 12px 15px;
            border: 1px solid var(--input-border);
            border-radius: 8px;
            background: var(--input-bg);
            color: var(--text);
            font-size: 16px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .chat-input input[type="text"]:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.2); /* –¢–µ–º–∞ primary */
        }

        .chat-input button {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .chat-input button:hover {
            background: var(--button-hover);
            transform: translateY(-2px);
        }

        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--primary);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1000;
            opacity: 0;
            animation: slideIn 0.5s forwards, fadeOut 0.5s forwards 4.5s;
        }

        @keyframes slideIn {
            from { bottom: 0; opacity: 0; }
            to { bottom: 20px; opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        /* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —è–∑—ã–∫–∞ –∏ —Ç–µ–º—ã */
        .lang-switcher, .theme-switcher {
            position: absolute;
            top: 20px;
            display: flex;
            gap: 10px;
        }
        .lang-switcher { left: 20px; }
        .theme-switcher { right: 20px; }
        .lang-btn, .theme-toggle {
            background: var(--card-bg);
            color: var(--text);
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        .lang-btn.active, .lang-btn:hover, .theme-toggle:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* –ú–µ–¥–∏–∞-–∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç–∏ */
        @media (max-width: 768px) {
            body { padding: 15px; }
            .container { padding: 20px; height: calc(100vh - 30px); }
            h1 { margin-bottom: 15px; }
            .lang-switcher, .theme-switcher {
                position: static;
                margin-top: 10px;
                justify-content: center;
                width: 100%;
            }
            .chat-input { flex-direction: column; }
            .chat-input button { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="lang-switcher">
        <button class="lang-btn active" onclick="setLanguage('uz_lat')">O'zbek</button>
        <button class="lang-btn" onclick="setLanguage('ru')">–†—É—Å—Å–∫–∏–π</button>
        <button class="lang-btn" onclick="setLanguage('en')">English</button>
    </div>
    <div class="theme-switcher">
        <button class="theme-toggle" onclick="toggleTheme()">üåô</button>
    </div>

    <div class="container">
        <h1 id="pageTitle">Chat with Operator</h1>
        <div id="chat_box" class="chat-box">
            <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
        </div>
        <div class="chat-input">
            <input type="text" id="chat_message_input" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
            <button id="send_button" onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
    </div>

    <script>
        const serverUrl = "{{ server_url }}";
        const urlParams = new URLSearchParams(window.location.search);
        const ticketId = "{{ ticket_id }}"; // –ü–æ–ª—É—á–∞–µ–º ticket_id –∏–∑ Flask-–∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        const socket = io(serverUrl);

        const translations = {
            uz_lat: {
                page_title: "Operator bilan chat",
                input_placeholder: "Xabaringizni kiriting...",
                send_button: "Yuborish",
                operator_label: "Operator",
                you_label: "Siz",
                error_connection: "Serverga ulanishda xato. Iltimos, keyinroq qayta urinib ko'ring.",
                error_send_message: "Xabar yuborishda xato:",
                error_load_history: "Chat tarixini yuklashda xato:",
                error_no_ticket: "Talon raqami topilmadi. Iltimos, to'g'ri havoladan foydalaning."
            },
            ru: {
                page_title: "–ß–∞—Ç —Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º",
                input_placeholder: "–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...",
                send_button: "–û—Ç–ø—Ä–∞–≤–∏—Ç—å",
                operator_label: "–û–ø–µ—Ä–∞—Ç–æ—Ä",
                you_label: "–í—ã",
                error_connection: "–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
                error_send_message: "–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:",
                error_load_history: "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞:",
                error_no_ticket: "–ù–æ–º–µ—Ä —Ç–∞–ª–æ–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É."
            },
            en: {
                page_title: "Chat with Operator",
                input_placeholder: "Enter your message...",
                send_button: "Send",
                operator_label: "Operator",
                you_label: "You",
                error_connection: "Error connecting to server. Please try again later.",
                error_send_message: "Error sending message:",
                error_load_history: "Error loading chat history:",
                error_no_ticket: "Ticket ID not found. Please use the correct link."
            }
        };
        let currentLang = 'uz_lat';

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        function showNotification(message, type = 'primary') {
            const existing = document.querySelector('.notification');
            if (existing) existing.remove();
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerText = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 5000);
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞
        async function loadChatHistory() {
            if (!ticketId) {
                showNotification(translations[currentLang].error_no_ticket, 'danger');
                return;
            }
            try {
                const response = await fetch(`${serverUrl}/get_chat_history/${ticketId}`);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const messages = await response.json();
                const chatBox = document.getElementById('chat_box');
                chatBox.innerHTML = ''; // –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π

                messages.forEach(data => {
                    appendMessage(data.sender_type, data.content, data.timestamp);
                });
                chatBox.scrollTop = chatBox.scrollHeight;
            } catch (error) {
                console.error("Error loading chat history:", error);
                showNotification(`${translations[currentLang].error_load_history} ${error.message}`, 'danger');
            }
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç-–±–æ–∫—Å
        function appendMessage(senderType, content, timestamp) {
            const chatBox = document.getElementById('chat_box');
            const msgDiv = document.createElement('div');
            const senderLabel = senderType === 'user' ? translations[currentLang].you_label : translations[currentLang].operator_label;
            
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è
            const date = new Date(timestamp);
            const timeString = date.toLocaleTimeString(currentLang.replace('_lat', '-Latn'), { hour: '2-digit', minute: '2-digit' });
            const dateString = date.toLocaleDateString(currentLang.replace('_lat', '-Latn'), { day: '2-digit', month: '2-digit', year: 'numeric' });

            msgDiv.className = `message ${senderType}`;
            msgDiv.innerHTML = `<strong>${senderLabel}:</strong> ${content}<span class="message-timestamp">${dateString} ${timeString}</span>`;
            chatBox.appendChild(msgDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        async function sendMessage() {
            const chatMessageInput = document.getElementById('chat_message_input');
            const content = chatMessageInput.value.trim();

            if (content === "") return;

            if (!ticketId) {
                showNotification(translations[currentLang].error_no_ticket, 'danger');
                return;
            }

            try {
                const response = await fetch(`${serverUrl}/send_chat_message`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ticket_id: ticketId,
                        sender_type: 'user', // –ö–ª–∏–µ–Ω—Ç –≤—Å–µ–≥–¥–∞ 'user'
                        content: content
                    })
                });
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
                appendMessage('user', content, new Date().toISOString()); 
                chatMessageInput.value = '';
            } catch (error) {
                console.error("Error sending message:", error);
                showNotification(`${translations[currentLang].error_send_message} ${error.message}`, 'danger');
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è 'message' –æ—Ç Socket.IO
        socket.on("chat_message", (data) => {
            // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–æ –¥–ª—è –Ω–∞—à–µ–≥–æ —Ç–∞–ª–æ–Ω–∞
            if (data.ticket_id === ticketId) {
                // –ï—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å 'user', –º—ã —É–∂–µ –¥–æ–±–∞–≤–∏–ª–∏ –µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ.
                // –ï—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å 'operator', –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–µ.
                if (data.sender === 'operator') {
                     appendMessage(data.sender, data.content, new Date().toISOString());
                }
            }
        });

        socket.on("connect", () => {
            if (ticketId) {
                socket.emit("join", { room: ticketId });
                console.log(`–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ —á–∞—Ç–∞: ${ticketId}`);
                loadChatHistory(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ –∫–æ–º–Ω–∞—Ç–µ
            } else {
                showNotification(translations[currentLang].error_no_ticket, 'danger');
            }
        });

        socket.on("disconnect", () => {
            showNotification(translations[currentLang].error_connection, 'danger');
        });

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ –Ω–∞–∂–∞—Ç–∏—é Enter
        document.getElementById('chat_message_input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–º–µ–Ω—ã —è–∑—ã–∫–∞
        function setLanguage(lang) {
            currentLang = lang;
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`button[onclick="setLanguage('${lang}')"]`).classList.add('active');
            
            document.getElementById('pageTitle').innerText = translations[lang].page_title;
            document.getElementById('chat_message_input').placeholder = translations[lang].input_placeholder;
            document.getElementById('send_button').innerText = translations[lang].send_button;
            
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —Å –Ω–æ–≤—ã–º —è–∑—ã–∫–æ–º (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ "–í—ã" / "–û–ø–µ—Ä–∞—Ç–æ—Ä" –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫)
            loadChatHistory();
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–º—ã
        function toggleTheme() {
            document.body.classList.toggle('dark');
            const isDark = document.body.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            document.querySelector('.theme-toggle').innerText = isDark ? '‚òÄÔ∏è' : 'üåô';
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        if (localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark');
            document.querySelector('.theme-toggle').innerText = '‚òÄÔ∏è';
        }
        
        setLanguage('uz_lat'); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —è–∑—ã–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        
        // Initial check for ticketId on page load
        if (!ticketId) {
            showNotification(translations[currentLang].error_no_ticket, 'danger');
        }
    </script>
</body>
</html>
