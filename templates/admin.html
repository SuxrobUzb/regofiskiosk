<!DOCTYPE html>
<html>
<head>
    <title>Admin Paneli</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Note: Using Tailwind CSS via CDN is suitable for development/prototyping. For production, consider installing it as a PostCSS plugin or using the Tailwind CLI for better performance and optimized builds. More info: https://tailwindcss.com/docs/installation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.min.js"></script>
    <style>
        /* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            transition: background 0.3s ease, color 0.3s ease;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* –¶–≤–µ—Ç–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Å–≤–µ—Ç–ª–æ–π —Ç–µ–º—ã */
        :root {
            --bg: #f4f7fa;
            --text: #2d3748;
            --card-bg: #ffffff;
            --primary: #1a73e8; /* –°–∏–Ω–∏–π */
            --secondary: #34c759; /* –ó–µ–ª–µ–Ω—ã–π */
            --danger: #e53e3e; /* –ö—Ä–∞—Å–Ω—ã–π */
            --border-color: #e2e8f0;
            --input-bg: #f9fafb;
            --input-border: #e2e8f0;
            --button-hover-primary: #1666c5;
            --button-hover-danger: #cc2c2c;
            --table-header-bg: #edf2f7;
            --table-row-hover: #f0f4f8;
            --notification-bg: #1a73e8;
            --notification-danger-bg: #e53e3e;
            --text-light: #6b7280; /* –ë–æ–ª–µ–µ —Å–≤–µ—Ç–ª—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ */
            --header-bg: #ffffff;
            --header-shadow: rgba(0,0,0,0.1);
        }

        /* –¶–≤–µ—Ç–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã */
        body.dark {
            --bg: #1a202c;
            --text: #e2e8f0;
            --card-bg: #2d3748;
            --primary: #63b3ed;
            --secondary: #68d391;
            --danger: #f56565;
            --border-color: #4a5568;
            --input-bg: #4a5568;
            --input-border: #6a768e;
            --button-hover-primary: #4299e1;
            --button-hover-danger: #e04f4f;
            --table-header-bg: #4a5568;
            --table-row-hover: #3c4456;
            --notification-bg: #63b3ed;
            --notification-danger-bg: #f56565;
            --text-light: #cbd5e0;
            --header-bg: #2d3748;
            --header-shadow: rgba(0,0,0,0.3);
        }

        /* Header Styles */
        .header {
            width: 100%;
            background: var(--header-bg);
            box-shadow: 0 2px 8px var(--header-shadow);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-radius: 0 0 12px 12px; /* –°–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–µ –Ω–∏–∂–Ω–∏–µ —É–≥–ª—ã */
            position: sticky; /* Sticky header */
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        h1 {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
            margin: 0; /* –£–±—Ä–∞–ª –æ—Ç—Å—Ç—É–ø—ã, —Ç–∞–∫ –∫–∞–∫ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–µ–ø–µ—Ä—å –≤ —Ö–µ–¥–µ—Ä–µ */
            text-align: center;
            flex-grow: 1; /* –ß—Ç–æ–±—ã –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∑–∞–Ω–∏–º–∞–ª —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–µ –º–µ—Å—Ç–æ */
        }

        .section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 30px;
            width: 100%;
            max-width: 1000px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        .section-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text);
        }

        .form-group input[type="text"],
        .form-group input[type="password"],
        .form-group input[type="email"],
        .form-group input[type="date"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--input-border);
            border-radius: 8px;
            background: var(--input-bg);
            color: var(--text);
            font-size: 16px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .form-group input[type="text"]:focus,
        .form-group input[type="password"]:focus,
        .form-group input[type="email"]:focus,
        .form-group input[type="date"]:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.2);
            outline: none;
        }

        .form-group.checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .form-group.checkbox-group label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 400;
            cursor: pointer;
        }
        .form-group.checkbox-group input[type="checkbox"] {
            width: auto;
            margin: 0;
            transform: scale(1.2);
        }

        .button {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.2s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .button:hover {
            background: var(--button-hover-primary);
            transform: translateY(-2px);
        }

        .button.danger {
            background: var(--danger);
        }

        .button.danger:hover {
            background: var(--button-hover-danger);
        }
        
        .button.secondary {
            background: var(--secondary);
        }

        .button.secondary:hover {
            background: #2a9448; /* –¢–µ–º–Ω–µ–µ –∑–µ–ª–µ–Ω—ã–π –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
        }


        .button:disabled {
            background: var(--border-color);
            color: var(--text-light);
            cursor: not-allowed;
            opacity: 0.7;
            transform: none;
            box-shadow: none;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
        }

        .data-table th, .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table th {
            background: var(--table-header-bg);
            font-weight: 600;
            color: var(--primary);
            text-transform: uppercase;
            font-size: 14px;
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .data-table tbody tr:hover {
            background: var(--table-row-hover);
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .action-buttons .button {
            padding: 8px 12px;
            font-size: 14px;
            border-radius: 6px;
        }

        /* Tabs styling */
        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            gap: 15px;
            flex-wrap: wrap;
            width: 100%;
            max-width: 1000px; /* –î–æ–±–∞–≤–ª–µ–Ω–æ, —á—Ç–æ–±—ã —Ç–∞–±—ã —Ç–æ–∂–µ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å */
        }

        .tab-button {
            background: var(--card-bg);
            color: var(--text);
            border: 1px solid var(--border-color);
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            flex-grow: 1;
            min-width: 150px;
            text-align: center;
        }

        .tab-button.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .tab-button:hover:not(.active) {
            background: var(--table-row-hover);
            transform: translateY(-2px);
        }

        .tab-content {
            display: none;
            width: 100%; /* –ó–∞–Ω–∏–º–∞–µ—Ç –≤—Å—é –¥–æ—Å—Ç—É–ø–Ω—É—é —à–∏—Ä–∏–Ω—É */
        }

        .tab-content.active {
            display: block;
        }

        /* Language and Theme Switchers */
        .lang-btn, .theme-toggle, .logout-button {
            background: var(--card-bg);
            color: var(--text);
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease, color 0.3s ease, border-color 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .lang-btn.active, .lang-btn:hover, .theme-toggle:hover, .logout-button:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .logout-button {
            background: var(--danger);
            border-color: var(--danger);
            color: white;
        }
        .logout-button:hover {
            background: var(--button-hover-danger);
            border-color: var(--button-hover-danger);
        }


        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--notification-bg);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1000;
            opacity: 0;
            animation: slideIn 0.5s forwards, fadeOut 0.5s forwards 4.5s;
        }
        .notification.danger {
            background-color: var(--notification-danger-bg);
        }

        @keyframes slideIn {
            from { bottom: 0; opacity: 0; }
            to { bottom: 20px; opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        /* Analytics Dashboard Specific Styles */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .analytics-card {
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            text-align: left;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .analytics-card h3 {
            font-size: 18px;
            color: var(--primary);
            margin-bottom: 10px;
            font-weight: 600;
        }

        .analytics-card p {
            font-size: 28px;
            font-weight: 700;
            color: var(--text);
        }
        .analytics-card .sub-text {
            font-size: 14px;
            color: var(--text-light);
        }

        .tickets-list-container {
            max-height: 400px; /* –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –≤—ã—Å–æ—Ç—É –¥–ª—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ */
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-top: 20px;
        }

        /* Service Tree View */
        .service-tree ul {
            list-style: none;
            padding-left: 20px;
            margin: 0;
        }

        .service-tree li {
            margin-bottom: 5px;
        }

        .service-tree .service-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px 0;
            cursor: pointer;
        }

        .service-tree .service-item:hover {
            background-color: var(--table-row-hover);
            border-radius: 4px;
        }

        .service-tree .service-name {
            font-weight: 500;
            color: var(--text);
        }

        .service-tree .service-type {
            font-size: 0.8em;
            color: white; /* Changed from text-light */
            background-color: var(--primary);
            padding: 2px 6px;
            border-radius: 4px;
        }
        .service-tree .service-type.category {
            background-color: var(--secondary);
        }
        
        .service-tree input[type="checkbox"] {
            margin-right: 8px; /* –û—Ç—Å—Ç—É–ø —Å–ø—Ä–∞–≤–∞ –æ—Ç —á–µ–∫–±–æ–∫—Å–∞ */
        }
        
        .service-tree .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            body { padding: 0; } /* –£–±–∏—Ä–∞–µ–º –ø–∞–¥–¥–∏–Ω–≥ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
            .header {
                padding: 10px 15px;
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
                border-radius: 0;
            }
            .header-left {
                width: 100%;
                justify-content: space-between;
            }
            .header-right {
                width: 100%;
                justify-content: space-around;
            }
            h1 { font-size: 24px; margin-bottom: 0; } /* –ú–µ–Ω—å—à–µ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
            .section { padding: 15px; margin-bottom: 20px; border-radius: 0; }
            .section-title { font-size: 20px; margin-bottom: 15px; }
            .tabs { flex-direction: column; gap: 10px; padding: 0 15px; } /* –ü–∞–¥–¥–∏–Ω–≥ –¥–ª—è —Ç–∞–±–æ–≤ */
            .tab-button { width: 100%; }
            .lang-switcher, .theme-switcher { position: static; justify-content: center; margin-top: 10px; }
            .analytics-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <h1>Admin Paneli</h1>
        </div>
        <div class="header-right">
            <div class="lang-switcher">
                <button class="lang-btn active" onclick="setLanguage('uz_lat')">O'zbek</button>
                <button class="lang-btn" onclick="setLanguage('uz_cyr')">–é–∑–±–µ–∫</button>
                <button class="lang-btn" onclick="setLanguage('ru')">–†—É—Å—Å–∫–∏–π</button>
                <button class="lang-btn" onclick="setLanguage('en')">English</button>
            </div>
            <button class="theme-toggle" onclick="toggleTheme()">üåô</button>
            <button class="logout-button" onclick="location.href='{{ server_url }}/admin_logout'">–í—ã–π—Ç–∏</button>
        </div>
    </div>

    <div class="tabs">
        <button class="tab-button active" data-tab="operators" id="operatorsTab">–û–ø–µ—Ä–∞—Ç–æ—Ä—ã</button>
        <button class="tab-button" data-tab="services" id="servicesTab">–£—Å–ª—É–≥–∏</button>
        <button class="tab-button" data-tab="assignments" id="assignmentsTab">–ù–∞–∑–Ω–∞—á–µ–Ω–∏—è</button>
        <button class="tab-button" data-tab="reports" id="reportsTab">–û—Ç—á–µ—Ç—ã</button>
        <button class="tab-button" data-tab="analytics" id="analyticsTab">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
    </div>

    <div id="operators_tab" class="tab-content active section">
        <h2 class="section-title" id="operatorListTitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º–∏</h2>
        <form id="operatorForm">
            <input type="hidden" id="operatorId">
            <div class="form-group">
                <label for="operatorName" id="labelOperatorName">–ò–º—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞:</label>
                <input type="text" id="operatorName" placeholder="–ò–º—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞" required>
            </div>
            <div class="form-group">
                <label for="operatorUsername" id="labelOperatorUsername">–õ–æ–≥–∏–Ω:</label>
                <input type="text" id="operatorUsername" placeholder="–õ–æ–≥–∏–Ω" required>
            </div>
            <div class="form-group">
                <label for="operatorPassword" id="labelOperatorPassword">–ü–∞—Ä–æ–ª—å:</label>
                <input type="password" id="operatorPassword" placeholder="–ü–∞—Ä–æ–ª—å">
                <small id="passwordHelpText" style="color: var(--text-light);"></small>
            </div>
            <div class="form-group">
                <label for="operatorNumber" id="labelOperatorNumber">–ù–æ–º–µ—Ä –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞:</label>
                <input type="text" id="operatorNumber" placeholder="–ù–æ–º–µ—Ä –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞" required>
            </div>
            <div class="form-group">
                <label for="telegramChatId" id="labelTelegramChatId">ID —á–∞—Ç–∞ Telegram (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
                <input type="text" id="telegramChatId" placeholder="ID —á–∞—Ç–∞ Telegram">
            </div>
            <div class="form-group">
                <label for="notificationPreference" id="labelNotificationPreference">–ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:</label>
                <select id="notificationPreference">
                    <option value="panel" id="optPanel">–¢–æ–ª—å–∫–æ –ø–∞–Ω–µ–ª—å</option>
                    <option value="telegram" id="optTelegram">–¢–æ–ª—å–∫–æ Telegram</option>
                    <option value="both" id="optBoth">–ü–∞–Ω–µ–ª—å –∏ Telegram</option>
                    <option value="none" id="optNone">–ù–∏—á–µ–≥–æ</option>
                </select>
            </div>
            <div class="button-group">
                <button type="submit" class="button" id="addOperatorBtn">–î–æ–±–∞–≤–∏—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞</button>
                <button type="button" class="button danger" id="cancelEditOperatorBtn" style="display:none;">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </form>

        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th id="thOperatorName">–ò–º—è</th>
                        <th id="thOperatorUsername">–õ–æ–≥–∏–Ω</th>
                        <th id="thOperatorNumber">–ù–æ–º–µ—Ä</th>
                        <th id="thTelegramChatId">Telegram ID</th>
                        <th id="thNotificationPreference">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</th>
                        <th id="thOperatorActions">–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="operatorsTableBody">
                    <!-- –û–ø–µ—Ä–∞—Ç–æ—Ä—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è —Å—é–¥–∞ -->
                </tbody>
            </table>
        </div>
    </div>

    <div id="services_tab" class="tab-content section">
        <h2 class="section-title" id="serviceListTitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥–∞–º–∏ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏</h2>
        <form id="serviceForm">
            <input type="hidden" id="serviceId">
            <div class="form-group">
                <label for="serviceName" id="labelServiceName">–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏/–∫–∞—Ç–µ–≥–æ—Ä–∏–∏:</label>
                <input type="text" id="serviceName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏/–∫–∞—Ç–µ–≥–æ—Ä–∏–∏" required>
            </div>
            <div class="form-group">
                <label for="parentService" id="labelParentService">–†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
                <select id="parentService">
                    <option value="" id="optNoParent">-- –ù–µ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è --</option>
                    <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è —Å—é–¥–∞ -->
                </select>
            </div>
            <div class="form-group">
                <label class="flex items-center gap-2">
                    <input type="checkbox" id="isServiceCheckbox">
                    <span id="labelIsService">–Ø–≤–ª—è–µ—Ç—Å—è —É—Å–ª—É–≥–æ–π (–∞ –Ω–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π)</span>
                </label>
            </div>
            <div class="button-group">
                <button type="submit" class="button" id="addServiceBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
                <button type="button" class="button danger" id="cancelEditServiceBtn" style="display:none;">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </form>

        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th id="thServiceListName">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                        <th id="thServiceListParent">–†–æ–¥–∏—Ç–µ–ª—å</th>
                        <th id="thServiceListType">–¢–∏–ø</th>
                        <th id="thServiceListActions">–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="servicesTableBody">
                    <!-- –£—Å–ª—É–≥–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è —Å—é–¥–∞ -->
                </tbody>
            </table>
        </div>
    </div>

    <div id="assignments_tab" class="tab-content section">
        <h2 class="section-title" id="assignmentTitle">–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —É—Å–ª—É–≥ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º</h2>
        <div class="form-group">
            <label for="assignOperatorSelect" id="labelAssignOperator">–í—ã–±–µ—Ä–∏—Ç–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞:</label>
            <select id="assignOperatorSelect" class="w-full p-2 border rounded-md"></select>
        </div>
        <div class="form-group">
            <label id="labelAssignedServices">–ù–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏:</label>
            <div id="servicesForAssignment" class="service-tree form-group checkbox-group">
                <!-- –î–µ—Ä–µ–≤–æ —É—Å–ª—É–≥ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è —Å—é–¥–∞ -->
            </div>
        </div>
        <button class="button" id="saveAssignmentsBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è</button>
    </div>

    <div id="reports_tab" class="tab-content section">
        <h2 class="section-title" id="reportGenerationTitle">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–æ–≤</h2>
        <form id="reportForm">
            <div class="form-group">
                <label for="reportOperator" id="labelReportOperator">–û–ø–µ—Ä–∞—Ç–æ—Ä (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
                <select id="reportOperator">
                    <option value="" id="optAllOperators">-- –í—Å–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã --</option>
                </select>
            </div>
            <div class="form-group">
                <label for="reportService" id="labelReportService">–£—Å–ª—É–≥–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
                <select id="reportService">
                    <option value="" id="optAllServices">-- –í—Å–µ —É—Å–ª—É–≥–∏ --</option>
                </select>
            </div>
            <div class="form-group">
                <label for="startDate" id="labelStartDate">–ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞:</label>
                <input type="date" id="startDate">
            </div>
            <div class="form-group">
                <label for="endDate" id="labelEndDate">–ö–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞:</label>
                <input type="date" id="endDate">
            </div>
            <div class="form-group">
                <label for="reportType" id="labelReportType">–¢–∏–ø –æ—Ç—á–µ—Ç–∞:</label>
                <select id="reportType">
                    <option value="detailed" id="optDetailed">–ü–æ–¥—Ä–æ–±–Ω—ã–π</option>
                    <option value="summary" id="optSummary">–°–≤–æ–¥–Ω—ã–π</option>
                    <option value="operator_performance" id="optOperatorPerformance">–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤</option>
                    <option value="service_performance" id="optServicePerformance">–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É—Å–ª—É–≥</option>
                </select>
            </div>
            <button type="submit" class="button" id="generateReportBtn">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç</button>
        </form>
    </div>

    <div id="analytics_tab" class="tab-content section">
        <h2 class="section-title" id="analyticsDashboardTitle">–ü–∞–Ω–µ–ª—å –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</h2>
        <p class="sub-text mb-4" id="lastUpdatedTime">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –ó–∞–≥—Ä—É–∑–∫–∞...</p>
        <div class="analytics-grid">
            <div class="analytics-card">
                <h3 id="totalTicketsTodayLabel">–í—Å–µ–≥–æ —Ç–∞–ª–æ–Ω–æ–≤ —Å–µ–≥–æ–¥–Ω—è</h3>
                <p id="totalTicketsTodayValue">0</p>
            </div>
            <div class="analytics-card">
                <h3 id="waitingTicketsLabel">–í –æ–∂–∏–¥–∞–Ω–∏–∏</h3>
                <p id="waitingTicketsValue">0</p>
                <span class="sub-text" id="avgWaitTimeLabel">–û–∂–∏–¥–∞–Ω–∏–µ: N/A</span>
            </div>
            <div class="analytics-card">
                <h3 id="calledTicketsLabel">–í—ã–∑–≤–∞–Ω—ã</h3>
                <p id="calledTicketsValue">0</p>
            </div>
            <div class="analytics-card">
                <h3 id="finishedTicketsTodayLabel">–ó–∞–≤–µ—Ä—à–µ–Ω—ã —Å–µ–≥–æ–¥–Ω—è</h3>
                <p id="finishedTicketsTodayValue">0</p>
                <span class="sub-text" id="avgServiceTimeLabel">–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ: N/A</span>
            </div>
        </div>

        <h3 class="section-title mt-8" id="currentQueueListTitle">–¢–µ–∫—É—â–∞—è –æ—á–µ—Ä–µ–¥—å</h3>
        <div class="tickets-list-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th id="thAnalyticsTicketNumber">–ù–æ–º–µ—Ä —Ç–∞–ª–æ–Ω–∞</th>
                        <th id="thAnalyticsStatus">–°—Ç–∞—Ç—É—Å</th>
                        <th id="thAnalyticsService">–£—Å–ª—É–≥–∞</th>
                        <th id="thAnalyticsOperator">–û–ø–µ—Ä–∞—Ç–æ—Ä</th>
                        <th id="thAnalyticsStartTime">–í—Ä–µ–º—è –≤—ã–¥–∞—á–∏</th>
                        <th id="thAnalyticsCallTime">–í—Ä–µ–º—è –≤—ã–∑–æ–≤–∞</th>
                        <th id="thAnalyticsEstimatedWait">–ü—Ä–∏–º. –æ–∂–∏–¥–∞–Ω–∏–µ</th>
                    </tr>
                </thead>
                <tbody id="activeTicketsTableBody">
                    <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ —Ç–∞–ª–æ–Ω—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è —Å—é–¥–∞ -->
                </tbody>
            </table>
        </div>
    </div>

    <div class="notification"></div>

    <script>
        const serverUrl = "{{ server_url }}";
        const socket = io(serverUrl);
        let allOperators = [];
        let allServices = []; // –í—Å–µ —É—Å–ª—É–≥–∏ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –¥–µ—Ä–µ–≤–∞
        let currentTab = 'operators'; // –¢–µ–∫—É—â–∞—è –∞–∫—Ç–∏–≤–Ω–∞—è –≤–∫–ª–∞–¥–∫–∞

        const translations = {
            uz_lat: {
                operators_tab: "Operatorlar",
                services_tab: "Xizmatlar",
                assignments_tab: "Tayinlashlar",
                reports_tab: "Hisobotlar",
                analytics_tab: "Tahlillar",
                operatorListTitle: "Operatorlarni boshqarish",
                labelOperatorName: "Operator nomi:",
                labelOperatorUsername: "Login:",
                labelOperatorPassword: "Parol:",
                passwordHelpText: "Parolni o'zgartirish uchun kiriting. Bo'sh qoldiring, agar o'zgartirmasangiz.",
                labelOperatorNumber: "Operator raqami:",
                labelTelegramChatId: "Telegram chat ID (ixtiyoriy):",
                labelNotificationPreference: "Bildirishnoma afzalliklari:",
                optPanel: "Faqat panel",
                optTelegram: "Faqat Telegram",
                optBoth: "Panel va Telegram",
                optNone: "Hech qanday",
                addOperatorBtn: "Operator qo'shish",
                editOperatorBtn: "Saqlash",
                cancelEditOperatorBtn: "Bekor qilish",
                thOperatorName: "Ism",
                thOperatorUsername: "Login",
                thOperatorNumber: "Raqam",
                thTelegramChatId: "Telegram ID",
                thNotificationPreference: "Bildirishnomalar",
                thOperatorActions: "Harakatlar",
                serviceListTitle: "Xizmatlar va toifalarni boshqarish",
                labelServiceName: "Xizmat/toifa nomi:",
                labelParentService: "Asosiy toifa (ixtiyoriy):",
                optNoParent: "-- Asosiy yo'q --",
                labelIsService: "Xizmat (toifa emas)",
                addServiceBtn: "Qo'shish",
                editServiceBtn: "Saqlash",
                cancelEditServiceBtn: "Bekor qilish",
                thServiceListName: "Nomi",
                thServiceListParent: "Asosiy",
                thServiceListType: "Turi",
                thServiceListActions: "Harakatlar",
                assignmentTitle: "Operatorlarga xizmatlarni tayinlash",
                labelAssignOperator: "Operatorni tanlang:",
                labelAssignedServices: "Tayinlangan xizmatlar:",
                saveAssignmentsBtn: "Tayinlashlarni saqlash",
                reportGenerationTitle: "Hisobot yaratish",
                labelReportOperator: "Operator (ixtiyoriy):",
                optAllOperators: "-- Barcha operatorlar --",
                labelReportService: "Xizmat (ixtiyoriy):",
                optAllServices: "-- Barcha xizmatlar --",
                labelStartDate: "Boshlang'ich sana:",
                labelEndDate: "Tugash sanasi:",
                labelReportType: "Hisobot turi:",
                optDetailed: "Batafsil",
                optSummary: "Umumiy",
                optOperatorPerformance: "Operator samaradorligi",
                optServicePerformance: "Xizmat samaradorligi",
                generateReportBtn: "Hisobot yaratish",
                analyticsDashboardTitle: "Haqiqiy vaqt tahlil paneli",
                totalTicketsTodayLabel: "Bugungi jami talonlar",
                waitingTicketsLabel: "Kutilmoqda",
                avgWaitTimeLabel: "O'rtacha kutish vaqti:",
                calledTicketsLabel: "Chaqirilgan",
                finishedTicketsTodayLabel: "Bugun yakunlangan",
                avgServiceTimeLabel: "O'rtacha xizmat ko'rsatish vaqti:",
                currentQueueListTitle: "Joriy navbat",
                thAnalyticsTicketNumber: "Talon raqami",
                thAnalyticsStatus: "Holat",
                thAnalyticsService: "Xizmat",
                thAnalyticsOperator: "Operator",
                thAnalyticsStartTime: "Berilgan vaqt",
                thAnalyticsCallTime: "Chaqirilgan vaqt",
                thAnalyticsEstimatedWait: "Taxm. kutish",
                confirm_delete_operator: "Operatoni o'chirishni tasdiqlaysizmi?",
                confirm_delete_service: "Xizmatni/toifani o'chirishni tasdiqlaysizmi?",
                success_add_operator: "Operator muvaffaqiyatli qo'shildi!",
                success_update_operator: "Operator muvaffaqiyatli yangilandi!",
                success_delete_operator: "Operator muvaffaqiyatli o'chirildi!",
                success_add_service: "Xizmat/toifa muvaffaqiyatli qo'shildi!",
                success_update_service: "Xizmat/toifa muvaffaqiyatli yangilandi!",
                success_delete_service: "Xizmat/toifa muvaffaqiyatli o'chirildi!",
                success_update_assignments: "Tayinlashlar muvaffaqiyatli yangilandi!",
                error_fetch: "Ma'lumotlarni yuklashda xato yuz berdi:",
                error_add: "Qo'shishda xato yuz berdi:",
                error_update: "Yangilashda xato yuz berdi:",
                error_delete: "O'chirishda xato yuz berdi:",
                error_already_exists: "Bunday nomdagi xizmat/toifa ushbu darajada allaqachon mavjud.",
                error_parent_not_category: "Noto'g'ri asosiy toifa yoki asosiy xizmat. Iltimos, kategoriyani tanlang.",
                error_delete_category_with_children: "Ichki toifalar yoki xizmatlarga ega kategoriyani o'chirish mumkin emas.",
                ticket_status_waiting: "Kutilmoqda",
                ticket_status_called: "Chaqirilgan",
                ticket_status_finished: "Tugatilgan",
                ticket_status_redirected: "Yo'naltirilgan",
                ticket_status_cancelled: "Bekor qilingan",
                logout: "Chiqish",
                category_type: "Kategoriya",
                service_type: "Xizmat",
                last_updated: "Oxirgi yangilanish:",
                invalid_date_range: "Boshlang'ich sana tugash sanasidan keyin bo'lishi mumkin emas."
            },
            uz_cyr: {
                operators_tab: "–û–ø–µ—Ä–∞—Ç–æ—Ä–ª–∞—Ä",
                services_tab: "–•–∏–∑–º–∞—Ç–ª–∞—Ä",
                assignments_tab: "–¢–∞–π–∏–Ω–ª–∞—à–ª–∞—Ä",
                reports_tab: "“≤–∏—Å–æ–±–æ—Ç–ª–∞—Ä",
                analytics_tab: "–¢–∞“≥–ª–∏–ª–ª–∞—Ä",
                operatorListTitle: "–û–ø–µ—Ä–∞—Ç–æ—Ä–ª–∞—Ä–Ω–∏ –±–æ—à“õ–∞—Ä–∏—à",
                labelOperatorName: "–û–ø–µ—Ä–∞—Ç–æ—Ä –Ω–æ–º–∏:",
                labelOperatorUsername: "–õ–æ–≥–∏–Ω:",
                labelOperatorPassword: "–ü–∞—Ä–æ–ª:",
                passwordHelpText: "–ü–∞—Ä–æ–ª–Ω–∏ —û–∑–≥–∞—Ä—Ç–∏—Ä–∏—à —É—á—É–Ω –∫–∏—Ä–∏—Ç–∏–Ω–≥. –ë—û—à “õ–æ–ª–¥–∏—Ä–∏–Ω–≥, –∞–≥–∞—Ä —û–∑–≥–∞—Ä—Ç–∏—Ä–º–∞—Å–∞–Ω–≥–∏–∑.",
                labelOperatorNumber: "–û–ø–µ—Ä–∞—Ç–æ—Ä —Ä–∞“õ–∞–º–∏:",
                labelTelegramChatId: "–¢–µ–ª–µ–≥—Ä–∞–º —á–∞—Ç ID (–∏—Ö—Ç–∏—ë—Ä–∏–π):",
                labelNotificationPreference: "–ë–∏–ª–¥–∏—Ä–∏—à–Ω–æ–º–∞ –∞—Ñ–∑–∞–ª–ª–∏–∫–ª–∞—Ä–∏:",
                optPanel: "–§–∞“õ–∞—Ç –ø–∞–Ω–µ–ª",
                optTelegram: "–§–∞“õ–∞—Ç –¢–µ–ª–µ–≥—Ä–∞–º",
                optBoth: "–ü–∞–Ω–µ–ª –≤–∞ –¢–µ–ª–µ–≥—Ä–∞–º",
                optNone: "“≤–µ—á “õ–∞–Ω–¥–∞–π",
                addOperatorBtn: "–û–ø–µ—Ä–∞—Ç–æ—Ä “õ—û—à–∏—à",
                editOperatorBtn: "–°–∞“õ–ª–∞—à",
                cancelEditOperatorBtn: "–ë–µ–∫–æ—Ä “õ–∏–ª–∏—à",
                thOperatorName: "–ò—Å–º",
                thOperatorUsername: "–õ–æ–≥–∏–Ω",
                thOperatorNumber: "–†–∞“õ–∞–º",
                thTelegramChatId: "–¢–µ–ª–µ–≥—Ä–∞–º ID",
                thNotificationPreference: "–ë–∏–ª–¥–∏—Ä–∏—à–Ω–æ–º–∞–ª–∞—Ä",
                thOperatorActions: "“≤–∞—Ä–∞–∫–∞—Ç–ª–∞—Ä",
                serviceListTitle: "–•–∏–∑–º–∞—Ç–ª–∞—Ä –≤–∞ —Ç–æ–∏—Ñ–∞–ª–∞—Ä–Ω–∏ –±–æ—à“õ–∞—Ä–∏—à",
                labelServiceName: "–•–∏–∑–º–∞—Ç/—Ç–æ–∏—Ñ–∞ –Ω–æ–º–∏:",
                labelParentService: "–ê—Å–æ—Å–∏–π —Ç–æ–∏—Ñ–∞ (–∏—Ö—Ç–∏—ë—Ä–∏–π):",
                optNoParent: "-- –ê—Å–æ—Å–∏–π –π—û“õ --",
                labelIsService: "–•–∏–∑–º–∞—Ç (—Ç–æ–∏—Ñ–∞ —ç–º–∞—Å)",
                addServiceBtn: "“ö—û—à–∏—à",
                editServiceBtn: "–°–∞“õ–ª–∞—à",
                cancelEditServiceBtn: "–ë–µ–∫–æ—Ä “õ–∏–ª–∏—à",
                thServiceListName: "–ù–æ–º–∏",
                thServiceListParent: "–ê—Å–æ—Å–∏–π",
                thServiceListType: "–¢—É—Ä–∏",
                thServiceListActions: "“≤–∞—Ä–∞–∫–∞—Ç–ª–∞—Ä",
                assignmentTitle: "–û–ø–µ—Ä–∞—Ç–æ—Ä–ª–∞—Ä–≥–∞ —Ö–∏–∑–º–∞—Ç–ª–∞—Ä–Ω–∏ —Ç–∞–π–∏–Ω–ª–∞—à",
                labelAssignOperator: "–û–ø–µ—Ä–∞—Ç–æ—Ä–Ω–∏ —Ç–∞–Ω–ª–∞–Ω–≥:",
                labelAssignedServices: "–¢–∞–π–∏–Ω–ª–∞–Ω–≥–∞–Ω —Ö–∏–∑–º–∞—Ç–ª–∞—Ä:",
                saveAssignmentsBtn: "–¢–∞–π–∏–Ω–ª–∞—à–ª–∞—Ä–Ω–∏ —Å–∞“õ–ª–∞—à",
                reportGenerationTitle: "“≤–∏—Å–æ–±–æ—Ç —è—Ä–∞—Ç–∏—à",
                labelReportOperator: "–û–ø–µ—Ä–∞—Ç–æ—Ä (–∏—Ö—Ç–∏—ë—Ä–∏–π):",
                optAllOperators: "-- –ë–∞—Ä—á–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–ª–∞—Ä --",
                labelReportService: "–•–∏–∑–º–∞—Ç (–∏—Ö—Ç–∏—ë—Ä–∏–π):",
                optAllServices: "-- –ë–∞—Ä—á–∞ —Ö–∏–∑–º–∞—Ç–ª–∞—Ä --",
                labelStartDate: "–ë–æ—à–ª–∞–Ω“ì–∏—á —Å–∞–Ω–∞:",
                labelEndDate: "–¢—É–≥–∞—à —Å–∞–Ω–∞—Å–∏:",
                labelReportType: "“≤–∏—Å–æ–±–æ—Ç —Ç—É—Ä–∏:",
                optDetailed: "–ë–∞—Ç–∞—Ñ—Å–∏–ª",
                optSummary: "–£–º—É–º–∏–π",
                optOperatorPerformance: "–û–ø–µ—Ä–∞—Ç–æ—Ä —Å–∞–º–∞—Ä–∞–¥–æ—Ä–ª–∏–≥–∏",
                optServicePerformance: "–•–∏–∑–º–∞—Ç —Å–∞–º–∞—Ä–∞–¥–æ—Ä–ª–∏–≥–∏",
                generateReportBtn: "“≤–∏—Å–æ–±–æ—Ç —è—Ä–∞—Ç–∏—à",
                analyticsDashboardTitle: "“≤–∞“õ–∏“õ–∏–π –≤–∞“õ—Ç —Ç–∞“≥–ª–∏–ª –ø–∞–Ω–µ–ª–∏",
                totalTicketsTodayLabel: "–ë—É–≥—É–Ω–≥–∏ –∂–∞–º–∏ —Ç–∞–ª–æ–Ω–ª–∞—Ä",
                waitingTicketsLabel: "–ö—É—Ç–∏–ª–º–æ“õ–¥–∞",
                avgWaitTimeLabel: "–é—Ä—Ç–∞—á–∞ –∫—É—Ç–∏—à –≤–∞“õ—Ç–∏:",
                calledTicketsLabel: "–ß–∞“õ–∏—Ä–∏–ª–≥–∞–Ω",
                finishedTicketsTodayLabel: "–ë—É–≥—É–Ω —è–∫—É–Ω–ª–∞–Ω–≥–∞–Ω",
                avgServiceTimeLabel: "–é—Ä—Ç–∞—á–∞ —Ö–∏–∑–º–∞—Ç –∫—û—Ä—Å–∞—Ç–∏—à –≤–∞“õ—Ç–∏:",
                currentQueueListTitle: "–ñ–æ—Ä–∏–π –Ω–∞–≤–±–∞—Ç",
                thAnalyticsTicketNumber: "–¢–∞–ª–æ–Ω —Ä–∞“õ–∞–º–∏",
                thAnalyticsStatus: "“≤–æ–ª–∞—Ç",
                thAnalyticsService: "–•–∏–∑–º–∞—Ç",
                thAnalyticsOperator: "–û–ø–µ—Ä–∞—Ç–æ—Ä",
                thAnalyticsStartTime: "–ë–µ—Ä–∏–ª–≥–∞–Ω –≤–∞“õ—Ç",
                thAnalyticsCallTime: "–ß–∞“õ–∏—Ä–∏–ª–≥–∞–Ω –≤–∞“õ—Ç",
                thAnalyticsEstimatedWait: "–¢–∞—Ö–º. –∫—É—Ç–∏—à",
                confirm_delete_operator: "–û–ø–µ—Ä–∞—Ç–æ—Ä–Ω–∏ —û—á–∏—Ä–∏—à–Ω–∏ —Ç–∞—Å–¥–∏“õ–ª–∞–π—Å–∏–∑–º–∏?",
                confirm_delete_service: "–•–∏–∑–º–∞—Ç–Ω–∏/—Ç–æ–∏—Ñ–∞–Ω–∏ —û—á–∏—Ä–∏—à–Ω–∏ —Ç–∞—Å–¥–∏“õ–ª–∞–π—Å–∏–∑–º–∏?",
                success_add_operator: "–û–ø–µ—Ä–∞—Ç–æ—Ä –º—É–≤–∞—Ñ—Ñ–∞“õ–∏—è—Ç–ª–∏ “õ—û—à–∏–ª–¥–∏!",
                success_update_operator: "–û–ø–µ—Ä–∞—Ç–æ—Ä –º—É–≤–∞—Ñ—Ñ–∞“õ–∏—è—Ç–ª–∏ —è–Ω–≥–∏–ª–∞–Ω–¥–∏!",
                success_delete_operator: "–û–ø–µ—Ä–∞—Ç–æ—Ä –º—É–≤–∞—Ñ—Ñ–∞“õ–∏—è—Ç–ª–∏ —û—á–∏—Ä–∏–ª–¥–∏!",
                success_add_service: "–•–∏–∑–º–∞—Ç/—Ç–æ–∏—Ñ–∞ –º—É–≤–∞—Ñ—Ñ–∞“õ–∏—è—Ç–ª–∏ “õ—û—à–∏–ª–¥–∏!",
                success_update_service: "–•–∏–∑–º–∞—Ç/—Ç–æ–∏—Ñ–∞ –º—É–≤–∞—Ñ—Ñ–∞“õ–∏—è—Ç–ª–∏ —è–Ω–≥–∏–ª–∞–Ω–¥–∏!",
                success_delete_service: "–•–∏–∑–º–∞—Ç/—Ç–æ–∏—Ñ–∞ –º—É–≤–∞—Ñ—Ñ–∞“õ–∏—è—Ç–ª–∏ —û—á–∏—Ä–∏–ª–¥–∏!",
                success_update_assignments: "–¢–∞–π–∏–Ω–ª–∞—à–ª–∞—Ä –º—É–≤–∞—Ñ—Ñ–∞“õ–∏—è—Ç–ª–∏ —è–Ω–≥–∏–ª–∞–Ω–¥–∏!",
                error_fetch: "–ú–∞—ä–ª—É–º–æ—Ç–ª–∞—Ä–Ω–∏ —é–∫–ª–∞—à–¥–∞ —Ö–∞—Ç–æ —é–∑ –±–µ—Ä–¥–∏:",
                error_add: "“ö—û—à–∏—à–¥–∞ —Ö–∞—Ç–æ —é–∑ –±–µ—Ä–¥–∏:",
                error_update: "–Ø–Ω–≥–∏–ª–∞—à–¥–∞ —Ö–∞—Ç–æ —é–∑ –±–µ—Ä–¥–∏:",
                error_delete: "–é—á–∏—Ä–∏—à–¥–∞ —Ö–∞—Ç–æ —é–∑ –±–µ—Ä–¥–∏:",
                error_already_exists: "–ë—É–Ω–¥–∞–π –Ω–æ–º–¥–∞–≥–∏ —Ö–∏–∑–º–∞—Ç/—Ç–æ–∏—Ñ–∞ —É—à–±—É –¥–∞—Ä–∞–∂–∞–¥–∞ –∞–ª–ª–∞“õ–∞—á–æ–Ω –º–∞–≤–∂—É–¥.",
                error_parent_not_category: "–ù–æ—Ç—û“ì—Ä–∏ –∞—Å–æ—Å–∏–π —Ç–æ–∏—Ñ–∞ —ë–∫–∏ –∞—Å–æ—Å–∏–π —Ö–∏–∑–º–∞—Ç. –ò–ª—Ç–∏–º–æ—Å, –∫–∞—Ç–µ–≥–æ—Ä–∏—è–Ω–∏ —Ç–∞–Ω–ª–∞–Ω–≥.",
                error_delete_category_with_children: "–ò—á–∫–∏ —Ç–æ–∏—Ñ–∞–ª–∞—Ä —ë–∫–∏ —Ö–∏–∑–º–∞—Ç–ª–∞—Ä–≥–∞ —ç–≥–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–Ω–∏ —û—á–∏—Ä–∏—à –º—É–º–∫–∏–Ω —ç–º–∞—Å.",
                ticket_status_waiting: "–ö—É—Ç–∏–ª–º–æ“õ–¥–∞",
                ticket_status_called: "–ß–∞“õ–∏—Ä–∏–ª–≥–∞–Ω",
                ticket_status_finished: "–¢—É–≥–∞—Ç–∏–ª–≥–∞–Ω",
                ticket_status_redirected: "–ô—û–Ω–∞–ª—Ç–∏—Ä–∏–ª–≥–∞–Ω",
                ticket_status_cancelled: "–ë–µ–∫–æ—Ä “õ–∏–ª–∏–Ω–≥–∞–Ω",
                logout: "–ß–∏“õ–∏—à",
                category_type: "–ö–∞—Ç–µ–≥–æ—Ä–∏—è",
                service_type: "–•–∏–∑–º–∞—Ç",
                last_updated: "–û—Ö–∏—Ä–≥–∏ —è–Ω–≥–∏–ª–∞–Ω–∏—à:",
                invalid_date_range: "–ë–æ—à–ª–∞–Ω“ì–∏—á —Å–∞–Ω–∞ —Ç—É–≥–∞—à —Å–∞–Ω–∞—Å–∏–¥–∞–Ω –∫–µ–π–∏–Ω –±—û–ª–∏—à–∏ –º—É–º–∫–∏–Ω —ç–º–∞—Å."
            },
            ru: {
                operators_tab: "–û–ø–µ—Ä–∞—Ç–æ—Ä—ã",
                services_tab: "–£—Å–ª—É–≥–∏",
                assignments_tab: "–ù–∞–∑–Ω–∞—á–µ–Ω–∏—è",
                reports_tab: "–û—Ç—á–µ—Ç—ã",
                analytics_tab: "–ê–Ω–∞–ª–∏—Ç–∏–∫–∞",
                operatorListTitle: "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º–∏",
                labelOperatorName: "–ò–º—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞:",
                labelOperatorUsername: "–õ–æ–≥–∏–Ω:",
                labelOperatorPassword: "–ü–∞—Ä–æ–ª—å:",
                passwordHelpText: "–í–≤–µ–¥–∏—Ç–µ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è. –û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ –Ω–µ –º–µ–Ω—è–µ—Ç–µ.",
                labelOperatorNumber: "–ù–æ–º–µ—Ä –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞:",
                labelTelegramChatId: "ID —á–∞—Ç–∞ Telegram (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):",
                labelNotificationPreference: "–ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:",
                optPanel: "–¢–æ–ª—å–∫–æ –ø–∞–Ω–µ–ª—å",
                optTelegram: "–¢–æ–ª—å–∫–æ Telegram",
                optBoth: "–ü–∞–Ω–µ–ª—å –∏ Telegram",
                optNone: "–ù–∏—á–µ–≥–æ",
                addOperatorBtn: "–î–æ–±–∞–≤–∏—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞",
                editOperatorBtn: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å",
                cancelEditOperatorBtn: "–û—Ç–º–µ–Ω–∞",
                thOperatorName: "–ò–º—è",
                thOperatorUsername: "–õ–æ–≥–∏–Ω",
                thOperatorNumber: "–ù–æ–º–µ—Ä",
                thTelegramChatId: "Telegram ID",
                thNotificationPreference: "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è",
                thOperatorActions: "–î–µ–π—Å—Ç–≤–∏—è",
                serviceListTitle: "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥–∞–º–∏ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏",
                labelServiceName: "–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏/–∫–∞—Ç–µ–≥–æ—Ä–∏–∏:",
                labelParentService: "–†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):",
                optNoParent: "-- –ù–µ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è --",
                labelIsService: "–Ø–≤–ª—è–µ—Ç—Å—è —É—Å–ª—É–≥–æ–π (–∞ –Ω–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π)",
                addServiceBtn: "–î–æ–±–∞–≤–∏—Ç—å",
                editServiceBtn: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å",
                cancelEditServiceBtn: "–û—Ç–º–µ–Ω–∞",
                thServiceListName: "–ù–∞–∑–≤–∞–Ω–∏–µ",
                thServiceListParent: "–†–æ–¥–∏—Ç–µ–ª—å",
                thServiceListType: "–¢–∏–ø",
                thServiceListActions: "–î–µ–π—Å—Ç–≤–∏—è",
                assignmentTitle: "–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —É—Å–ª—É–≥ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º",
                labelAssignOperator: "–í—ã–±–µ—Ä–∏—Ç–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞:",
                labelAssignedServices: "–ù–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏:",
                saveAssignmentsBtn: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è",
                reportGenerationTitle: "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–æ–≤",
                labelReportOperator: "–û–ø–µ—Ä–∞—Ç–æ—Ä (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):",
                optAllOperators: "-- –í—Å–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã --",
                labelReportService: "–£—Å–ª—É–≥–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):",
                optAllServices: "-- –í—Å–µ —É—Å–ª—É–≥–∏ --",
                labelStartDate: "–ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞:",
                labelEndDate: "–ö–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞:",
                labelReportType: "–¢–∏–ø –æ—Ç—á–µ—Ç–∞:",
                optDetailed: "–ü–æ–¥—Ä–æ–±–Ω—ã–π",
                optSummary: "–°–≤–æ–¥–Ω—ã–π",
                optOperatorPerformance: "–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤",
                optServicePerformance: "–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É—Å–ª—É–≥",
                generateReportBtn: "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç",
                analyticsDashboardTitle: "–ü–∞–Ω–µ–ª—å –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏",
                totalTicketsTodayLabel: "–í—Å–µ–≥–æ —Ç–∞–ª–æ–Ω–æ–≤ —Å–µ–≥–æ–¥–Ω—è",
                waitingTicketsLabel: "–í –æ–∂–∏–¥–∞–Ω–∏–∏",
                avgWaitTimeLabel: "–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è:",
                calledTicketsLabel: "–í—ã–∑–≤–∞–Ω—ã",
                finishedTicketsTodayLabel: "–ó–∞–≤–µ—Ä—à–µ–Ω—ã —Å–µ–≥–æ–¥–Ω—è",
                avgServiceTimeLabel: "–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è:",
                currentQueueListTitle: "–¢–µ–∫—É—â–∞—è –æ—á–µ—Ä–µ–¥—å",
                thAnalyticsTicketNumber: "–ù–æ–º–µ—Ä —Ç–∞–ª–æ–Ω–∞",
                thAnalyticsStatus: "–°—Ç–∞—Ç—É—Å",
                thAnalyticsService: "–£—Å–ª—É–≥–∞",
                thAnalyticsOperator: "–û–ø–µ—Ä–∞—Ç–æ—Ä",
                thAnalyticsStartTime: "–í—Ä–µ–º—è –≤—ã–¥–∞—á–∏",
                thAnalyticsCallTime: "–í—Ä–µ–º—è –≤—ã–∑–æ–≤–∞",
                thAnalyticsEstimatedWait: "–ü—Ä–∏–º. –æ–∂–∏–¥–∞–Ω–∏–µ",
                confirm_delete_operator: "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É–¥–∞–ª–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞?",
                confirm_delete_service: "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É–¥–∞–ª–µ–Ω–∏–µ —É—Å–ª—É–≥–∏/–∫–∞—Ç–µ–≥–æ—Ä–∏–∏?",
                success_add_operator: "–û–ø–µ—Ä–∞—Ç–æ—Ä —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!",
                success_update_operator: "–û–ø–µ—Ä–∞—Ç–æ—Ä —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!",
                success_delete_operator: "–û–ø–µ—Ä–∞—Ç–æ—Ä —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!",
                success_add_service: "–£—Å–ª—É–≥–∞/–∫–∞—Ç–µ–≥–æ—Ä–∏—è —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞!",
                success_update_service: "–£—Å–ª—É–≥–∞/–∫–∞—Ç–µ–≥–æ—Ä–∏—è —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!",
                success_delete_service: "–£—Å–ª—É–≥–∞/–∫–∞—Ç–µ–≥–æ—Ä–∏—è —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞!",
                success_update_assignments: "–ù–∞–∑–Ω–∞—á–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!",
                error_fetch: "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:",
                error_add: "–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏:",
                error_update: "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏:",
                error_delete: "–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏:",
                error_already_exists: "–£—Å–ª—É–≥–∞/–∫–∞—Ç–µ–≥–æ—Ä–∏—è —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –Ω–∞ —ç—Ç–æ–º —É—Ä–æ–≤–Ω–µ.",
                error_parent_not_category: "–ù–µ–≤–µ—Ä–Ω–∞—è —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è –∏–ª–∏ —Ä–æ–¥–∏—Ç–µ–ª—å —è–≤–ª—è–µ—Ç—Å—è —É—Å–ª—É–≥–æ–π. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é.",
                error_delete_category_with_children: "–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ –∏–ª–∏ —É—Å–ª—É–≥–∞–º–∏.",
                ticket_status_waiting: "–í –æ–∂–∏–¥–∞–Ω–∏–∏",
                ticket_status_called: "–í—ã–∑–≤–∞–Ω",
                ticket_status_finished: "–ó–∞–≤–µ—Ä—à–µ–Ω",
                ticket_status_redirected: "–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω",
                ticket_status_cancelled: "–û—Ç–º–µ–Ω–µ–Ω",
                logout: "–í—ã–π—Ç–∏",
                category_type: "–ö–∞—Ç–µ–≥–æ—Ä–∏—è",
                service_type: "–£—Å–ª—É–≥–∞",
                last_updated: "–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:",
                invalid_date_range: "–ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–∑–∂–µ –∫–æ–Ω–µ—á–Ω–æ–π –¥–∞—Ç—ã."
            },
            en: {
                operators_tab: "Operators",
                services_tab: "Services",
                assignments_tab: "Assignments",
                reports_tab: "Reports",
                analytics_tab: "Analytics",
                operatorListTitle: "Manage Operators",
                labelOperatorName: "Operator Name:",
                labelOperatorUsername: "Username:",
                labelOperatorPassword: "Password:",
                passwordHelpText: "Enter to change password. Leave blank if not changing.",
                labelOperatorNumber: "Operator Number:",
                labelTelegramChatId: "Telegram Chat ID (Optional):",
                labelNotificationPreference: "Notification Preference:",
                optPanel: "Panel only",
                optTelegram: "Telegram only",
                optBoth: "Panel and Telegram",
                optNone: "None",
                addOperatorBtn: "Add Operator",
                editOperatorBtn: "Save",
                cancelEditOperatorBtn: "Cancel",
                thOperatorName: "Name",
                thOperatorUsername: "Username",
                thOperatorNumber: "Number",
                thTelegramChatId: "Telegram ID",
                thNotificationPreference: "Notifications",
                thOperatorActions: "Actions",
                serviceListTitle: "Manage Services and Categories",
                labelServiceName: "Service/Category Name:",
                labelParentService: "Parent Category (Optional):",
                optNoParent: "-- No parent --",
                labelIsService: "Is a Service (not a Category)",
                addServiceBtn: "Add",
                editServiceBtn: "Save",
                cancelEditServiceBtn: "Cancel",
                thServiceListName: "Name",
                thServiceListParent: "Parent",
                thServiceListType: "Type",
                thServiceListActions: "Actions",
                assignmentTitle: "Assign Services to Operators",
                labelAssignOperator: "Select Operator:",
                labelAssignedServices: "Assigned Services:",
                saveAssignmentsBtn: "Save Assignments",
                reportGenerationTitle: "Generate Reports",
                labelReportOperator: "Operator (Optional):",
                optAllOperators: "-- All Operators --",
                labelReportService: "Service (Optional):",
                optAllServices: "-- All Services --",
                labelStartDate: "Start Date:",
                labelEndDate: "End Date:",
                labelReportType: "Report Type:",
                optDetailed: "Detailed",
                optSummary: "Summary",
                optOperatorPerformance: "Operator Performance",
                optServicePerformance: "Service Performance",
                generateReportBtn: "Generate Report",
                analyticsDashboardTitle: "Real-time Analytics Dashboard",
                totalTicketsTodayLabel: "Total Tickets Today",
                waitingTicketsLabel: "Waiting",
                avgWaitTimeLabel: "Avg Wait Time:",
                calledTicketsLabel: "Called",
                finishedTicketsTodayLabel: "Finished Today",
                avgServiceTimeLabel: "Avg Service Time:",
                currentQueueListTitle: "Current Queue",
                thAnalyticsTicketNumber: "Ticket Number",
                thAnalyticsStatus: "Status",
                thAnalyticsService: "Service",
                thAnalyticsOperator: "Operator",
                thAnalyticsStartTime: "Issue Time",
                thAnalyticsCallTime: "Call Time",
                thAnalyticsEstimatedWait: "Est. Wait",
                confirm_delete_operator: "Confirm deletion of operator?",
                confirm_delete_service: "Confirm deletion of service/category?",
                success_add_operator: "Operator added successfully!",
                success_update_operator: "Operator updated successfully!",
                success_delete_operator: "Operator deleted successfully!",
                success_add_service: "Service/category added successfully!",
                success_update_service: "Service/category updated successfully!",
                success_delete_service: "Service/category deleted successfully!",
                success_update_assignments: "Assignments updated successfully!",
                error_fetch: "Error fetching data:",
                error_add: "Error adding:",
                error_update: "Error updating:",
                error_delete: "Error deleting:",
                error_already_exists: "Service/category with this name already exists at this level.",
                error_parent_not_category: "Invalid parent category or parent is a service. Please select a category.",
                error_delete_category_with_children: "Cannot delete category with existing sub-categories or services.",
                ticket_status_waiting: "Waiting",
                ticket_status_called: "Called",
                ticket_status_finished: "Finished",
                ticket_status_redirected: "Redirected",
                ticket_status_cancelled: "Cancelled",
                logout: "Logout",
                category_type: "Category",
                service_type: "Service",
                last_updated: "Last updated:",
                invalid_date_range: "Start date cannot be after end date."
            }
        };
        let currentLang = 'uz_lat'; // Default language

        function showNotification(message, type = 'primary') {
            const existing = document.querySelector('.notification');
            if (existing) existing.remove();
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerText = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 5000);
        }

        // Function to open specific tab
        function openTab(tabName) {
            currentTab = tabName;
            // Deactivate all tab buttons and hide all tab contents
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Activate the selected tab button and show its content
            document.getElementById(`${tabName}Tab`).classList.add('active');
            document.getElementById(`${tabName}_tab`).classList.add('active');

            // Load data for the active tab
            if (tabName === 'operators') {
                loadOperators();
            } else if (tabName === 'services') {
                loadServices();
            } else if (tabName === 'assignments') {
                loadOperatorsForAssignments();
                loadServicesForAssignments(); // Ensures all services are loaded to render checkboxes
            } else if (tabName === 'reports') {
                fetchOperatorsForReports();
                fetchServicesForReports();
            } else if (tabName === 'analytics') {
                updateAnalyticsDashboard();
            }
        }

        // --- Operator Management ---
        async function loadOperators() {
            try {
                const response = await fetch(`${serverUrl}/api/operators`);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                allOperators = await response.json(); // Store all operators globally
                const tableBody = document.getElementById('operatorsTableBody');
                tableBody.innerHTML = '';
                allOperators.forEach(operator => {
                    const row = tableBody.insertRow();
                    row.insertCell().innerText = operator.name;
                    row.insertCell().innerText = operator.username;
                    row.insertCell().innerText = operator.operator_number;
                    row.insertCell().innerText = operator.telegram_chat_id || 'N/A';
                    row.insertCell().innerText = translations[currentLang][`opt${operator.notification_preference.charAt(0).toUpperCase() + operator.notification_preference.slice(1)}`];
                    
                    const actionsCell = row.insertCell();
                    const editButton = document.createElement('button');
                    editButton.innerText = translations[currentLang].editOperatorBtn;
                    editButton.className = 'button secondary'; // Changed to secondary for edit
                    editButton.onclick = () => editOperator(operator);

                    const deleteButton = document.createElement('button');
                    deleteButton.innerText = translations[currentLang].error_delete.split(":")[0]; // "–£–¥–∞–ª–∏—Ç—å"
                    deleteButton.className = 'button danger ml-2';
                    deleteButton.onclick = () => deleteOperator(operator.id);

                    actionsCell.classList.add('action-buttons');
                    actionsCell.appendChild(editButton);
                    actionsCell.appendChild(deleteButton);
                });
                resetOperatorForm(); // Reset form after loading
            } catch (error) {
                console.error("Error loading operators:", error);
                showNotification(`${translations[currentLang].error_fetch} ${error.message}`, 'danger');
            }
        }

        function resetOperatorForm() {
            document.getElementById('operatorId').value = '';
            document.getElementById('operatorName').value = '';
            document.getElementById('operatorUsername').value = '';
            document.getElementById('operatorPassword').value = '';
            document.getElementById('operatorNumber').value = '';
            document.getElementById('telegramChatId').value = '';
            document.getElementById('notificationPreference').value = 'panel';
            document.getElementById('addOperatorBtn').innerText = translations[currentLang].addOperatorBtn;
            document.getElementById('addOperatorBtn').classList.remove('secondary');
            document.getElementById('cancelEditOperatorBtn').style.display = 'none';
            document.getElementById('passwordHelpText').innerText = ''; // Clear help text
        }

        function editOperator(operator) {
            document.getElementById('operatorId').value = operator.id;
            document.getElementById('operatorName').value = operator.name;
            document.getElementById('operatorUsername').value = operator.username;
            document.getElementById('operatorNumber').value = operator.operator_number;
            document.getElementById('telegramChatId').value = operator.telegram_chat_id || '';
            document.getElementById('notificationPreference').value = operator.notification_preference || 'panel';
            document.getElementById('operatorPassword').value = ''; // Clear password field for security
            document.getElementById('passwordHelpText').innerText = translations[currentLang].passwordHelpText;

            document.getElementById('addOperatorBtn').innerText = translations[currentLang].editOperatorBtn;
            document.getElementById('addOperatorBtn').classList.add('secondary'); // Optional: change button color
            document.getElementById('cancelEditOperatorBtn').style.display = 'inline-block';
        }

        document.getElementById('operatorForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const operatorId = document.getElementById('operatorId').value;
            const name = document.getElementById('operatorName').value;
            const username = document.getElementById('operatorUsername').value;
            const password = document.getElementById('operatorPassword').value;
            const operator_number = document.getElementById('operatorNumber').value;
            const telegram_chat_id = document.getElementById('telegramChatId').value;
            const notification_preference = document.getElementById('notificationPreference').value;

            const method = operatorId ? 'PUT' : 'POST';
            const url = operatorId ? `${serverUrl}/api/operators/${operatorId}` : `${serverUrl}/api/operators`;
            
            const body = { name, username, operator_number, telegram_chat_id, notification_preference };
            if (password) { // Only send password if it's not empty
                body.password = password;
            }

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
                }
                showNotification(operatorId ? translations[currentLang].success_update_operator : translations[currentLang].success_add_operator);
                loadOperators(); // Reload operators after add/edit
            } catch (error) {
                console.error("Error saving operator:", error);
                showNotification(`${operatorId ? translations[currentLang].error_update : translations[currentLang].error_add} ${error.message}`, 'danger');
            }
        });

        document.getElementById('cancelEditOperatorBtn').addEventListener('click', resetOperatorForm);

        async function deleteOperator(id) {
            if (!confirm(translations[currentLang].confirm_delete_operator)) return;
            try {
                const response = await fetch(`${serverUrl}/api/operators/${id}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
                }
                showNotification(translations[currentLang].success_delete_operator);
                loadOperators(); // Reload operators after deletion
            } catch (error) {
                console.error("Error deleting operator:", error);
                showNotification(`${translations[currentLang].error_delete} ${error.message}`, 'danger');
            }
        }

        // --- Service Management ---
        async function loadServices() {
            try {
                const response = await fetch(`${serverUrl}/api/services`);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                allServices = await response.json(); // Store all services globally
                
                const tableBody = document.getElementById('servicesTableBody');
                tableBody.innerHTML = '';
                const parentServiceSelect = document.getElementById('parentService');
                parentServiceSelect.innerHTML = `<option value="" id="optNoParent">${translations[currentLang].optNoParent}</option>`;

                // Populate parentService dropdown with categories (is_service = 0)
                allServices.filter(s => !s.is_service).forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.innerText = category.name;
                    parentServiceSelect.appendChild(option);
                });

                // Render services in table
                allServices.forEach(service => {
                    const row = tableBody.insertRow();
                    row.insertCell().innerText = service.name;
                    // Find the parent name
                    const parent = allServices.find(s => s.id === service.parent_id);
                    row.insertCell().innerText = parent ? parent.name : 'N/A';
                    row.insertCell().innerText = service.is_service ? translations[currentLang].service_type : translations[currentLang].category_type;
                    
                    const actionsCell = row.insertCell();
                    const editButton = document.createElement('button');
                    editButton.innerText = translations[currentLang].editServiceBtn;
                    editButton.className = 'button secondary';
                    editButton.onclick = () => editService(service);

                    const deleteButton = document.createElement('button');
                    deleteButton.innerText = translations[currentLang].error_delete.split(":")[0];
                    deleteButton.className = 'button danger ml-2';
                    deleteButton.onclick = () => deleteService(service.id);

                    actionsCell.classList.add('action-buttons');
                    actionsCell.appendChild(editButton);
                    actionsCell.appendChild(deleteButton);
                });
                resetServiceForm();
            } catch (error) {
                console.error("Error loading services:", error);
                showNotification(`${translations[currentLang].error_fetch} ${error.message}`, 'danger');
            }
        }

        function resetServiceForm() {
            document.getElementById('serviceId').value = '';
            document.getElementById('serviceName').value = '';
            document.getElementById('parentService').value = '';
            document.getElementById('isServiceCheckbox').checked = false;
            document.getElementById('addServiceBtn').innerText = translations[currentLang].addServiceBtn;
            document.getElementById('addServiceBtn').classList.remove('secondary');
            document.getElementById('cancelEditServiceBtn').style.display = 'none';
        }

        function editService(service) {
            document.getElementById('serviceId').value = service.id;
            document.getElementById('serviceName').value = service.name;
            document.getElementById('parentService').value = service.parent_id || '';
            document.getElementById('isServiceCheckbox').checked = service.is_service;

            document.getElementById('addServiceBtn').innerText = translations[currentLang].editServiceBtn;
            document.getElementById('addServiceBtn').classList.add('secondary');
            document.getElementById('cancelEditServiceBtn').style.display = 'inline-block';
        }

        document.getElementById('serviceForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const serviceId = document.getElementById('serviceId').value;
            const name = document.getElementById('serviceName').value;
            const parent_id = document.getElementById('parentService').value || null;
            const is_service = document.getElementById('isServiceCheckbox').checked ? 1 : 0;

            const method = serviceId ? 'PUT' : 'POST';
            const url = serviceId ? `${serverUrl}/api/services/${serviceId}` : `${serverUrl}/api/services`;
            
            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, parent_id, is_service })
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
                }
                showNotification(serviceId ? translations[currentLang].success_update_service : translations[currentLang].success_add_service);
                loadServices(); // Reload services after add/edit
                // Also reload services for assignments in case of changes
                loadServicesForAssignments(); 
            } catch (error) {
                console.error("Error saving service:", error);
                showNotification(`${serviceId ? translations[currentLang].error_update : translations[currentLang].error_add} ${error.message}`, 'danger');
            }
        });

        document.getElementById('cancelEditServiceBtn').addEventListener('click', resetServiceForm);

        async function deleteService(id) {
            if (!confirm(translations[currentLang].confirm_delete_service)) return;
            try {
                const response = await fetch(`${serverUrl}/api/services/${id}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
                }
                showNotification(translations[currentLang].success_delete_service);
                loadServices(); // Reload services after deletion
                // Also reload services for assignments in case of changes
                loadServicesForAssignments(); 
            } catch (error) {
                console.error("Error deleting service:", error);
                showNotification(`${translations[currentLang].error_delete} ${error.message}`, 'danger');
            }
        }

        // --- Assignments Tab ---
        async function loadOperatorsForAssignments() {
            try {
                const response = await fetch(`${serverUrl}/api/get_all_operators`);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const operators = await response.json();
                const select = document.getElementById('assignOperatorSelect');
                select.innerHTML = `<option value="">-- ${translations[currentLang].labelAssignOperator} --</option>`; // Default option
                operators.forEach(op => {
                    const option = document.createElement('option');
                    option.value = op.id;
                    option.innerText = op.name;
                    select.appendChild(option);
                });
                select.onchange = loadAssignedServices; // Load assignments when operator is selected
            } catch (error) {
                console.error("Error loading operators for assignments:", error);
                showNotification(`${translations[currentLang].error_fetch} ${error.message}`, 'danger');
            }
        }

        async function loadServicesForAssignments() {
            try {
                // This route should fetch all services, including categories, that can be assigned.
                // The backend needs to expose this endpoint.
                const response = await fetch(`${serverUrl}/api/services_for_assignment`);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                allServices = await response.json(); // Update allServices
                const servicesForAssignmentDiv = document.getElementById('servicesForAssignment');
                servicesForAssignmentDiv.innerHTML = ''; // Clear previous tree
                renderServiceTreeForAssignment(allServices, null, servicesForAssignmentDiv);
            } catch (error) {
                console.error("Error loading services for assignment tree:", error);
                showNotification(`${translations[currentLang].error_fetch} ${error.message}`, 'danger');
            }
        }

        function renderServiceTreeForAssignment(services, parentId, containerElement) {
            const children = services.filter(s => s.parent_id === parentId);
            if (children.length === 0 && parentId !== null && !services.some(s => s.parent_id === parentId)) {
                return; // Don't create empty ul for leaf nodes if no children
            }

            const ul = document.createElement('ul');
            ul.className = parentId === null ? '' : 'ml-4'; // Indent children, no indent for top level

            children.forEach(item => {
                const li = document.createElement('li');
                li.className = 'mb-1';
                
                const label = document.createElement('label');
                label.className = 'checkbox-label'; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è —Å—Ç–∏–ª–µ–π

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = item.id;
                checkbox.dataset.isService = item.is_service; // Store if it's a service
                checkbox.className = 'form-checkbox h-5 w-5 text-primary-500 rounded';

                const span = document.createElement('span');
                span.className = 'text-base text-gray-700 dark:text-gray-300';
                span.innerText = item.name;

                const typeSpan = document.createElement('span');
                typeSpan.className = `ml-2 px-2 py-1 text-xs font-semibold rounded-full`;
                typeSpan.innerText = item.is_service ? translations[currentLang].service_type : translations[currentLang].category_type; // Use localized text
                typeSpan.style.backgroundColor = item.is_service ? 'var(--primary)' : 'var(--secondary)'; // Use CSS variables

                label.appendChild(checkbox);
                label.appendChild(span);
                label.appendChild(typeSpan);
                li.appendChild(label);
                ul.appendChild(li);

                if (!item.is_service) { // If it's a category, render its children
                    renderServiceTreeForAssignment(services, item.id, li); // Pass li as container for children
                }
            });

            if (children.length > 0 || parentId === null) { // Only append if there are children or it's the root
                containerElement.appendChild(ul);
            }
        }


        async function loadAssignedServices() {
            const operatorId = document.getElementById('assignOperatorSelect').value;
            const servicesForAssignmentDiv = document.getElementById('servicesForAssignment');
            // Clear all checkboxes before loading new assignments
            servicesForAssignmentDiv.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);


            if (!operatorId) {
                return; // No operator selected, do nothing
            }

            try {
                const response = await fetch(`${serverUrl}/api/operator_service_assignments?operator_id=${operatorId}`);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const assignedServiceIds = await response.json();
                
                // Check the checkboxes for assigned services
                assignedServiceIds.forEach(serviceId => {
                    const checkbox = servicesForAssignmentDiv.querySelector(`input[type="checkbox"][value="${serviceId}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });

            } catch (error) {
                console.error("Error loading assigned services:", error);
                showNotification(`${translations[currentLang].error_fetch} ${error.message}`, 'danger');
            }
        }

        document.getElementById('saveAssignmentsBtn').addEventListener('click', async function() {
            const operatorId = document.getElementById('assignOperatorSelect').value;
            if (!operatorId) {
                showNotification(translations[currentLang].labelAssignOperator, 'danger');
                return;
            }

            const selectedServiceIds = Array.from(document.querySelectorAll('#servicesForAssignment input[type="checkbox"]:checked'))
                                            .map(checkbox => parseInt(checkbox.value));
            try {
                const response = await fetch(`${serverUrl}/api/operator_service_assignments`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ operator_id: operatorId, service_ids: selectedServiceIds })
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
                }
                showNotification(translations[currentLang].success_update_assignments);
            } catch (error) {
                console.error("Error saving assignments:", error);
                showNotification(`${translations[currentLang].error_update} ${error.message}`, 'danger');
            }
        });

        // --- Reports Tab ---
        async function fetchOperatorsForReports() {
            try {
                const response = await fetch(`${serverUrl}/api/get_all_operators`);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const operators = await response.json();
                const select = document.getElementById('reportOperator');
                select.innerHTML = `<option value="" id="optAllOperators">${translations[currentLang].optAllOperators}</option>`;
                operators.forEach(op => {
                    const option = document.createElement('option');
                    option.value = op.id;
                    option.innerText = op.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error("Error loading operators for reports:", error);
                showNotification(`${translations[currentLang].error_fetch} ${error.message}`, 'danger');
            }
        }

        async function fetchServicesForReports() {
            try {
                // –î–æ–±–∞–≤–∏–º –Ω–æ–≤—ã–π API-—ç–Ω–¥–ø–æ–∏–Ω—Ç –≤ app.py, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø–ª–æ—Å–∫–∏–π —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —É—Å–ª—É–≥ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
                const response = await fetch(`${serverUrl}/api/get_all_services_flat`);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const services = await response.json();
                const select = document.getElementById('reportService');
                select.innerHTML = `<option value="" id="optAllServices">${translations[currentLang].optAllServices}</option>`;
                services.forEach(svc => {
                    const option = document.createElement('option');
                    option.value = svc.id;
                    option.innerText = svc.name + (svc.is_service ? ` (${translations[currentLang].service_type})` : ` (${translations[currentLang].category_type})`);
                    select.appendChild(option);
                });
            } catch (error) {
                console.error("Error loading services for reports:", error);
                showNotification(`${translations[currentLang].error_fetch} ${error.message}`, 'danger');
            }
        }

        document.getElementById('reportForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const operatorId = document.getElementById('reportOperator').value || null;
            const serviceId = document.getElementById('reportService').value || null;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const reportType = document.getElementById('reportType').value;

            // –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞—Ç
            if (startDate && endDate && new Date(startDate) > new Date(endDate)) {
                showNotification(translations[currentLang].invalid_date_range, 'danger');
                return;
            }

            try {
                const response = await fetch(`${serverUrl}/export_report`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        operator_id: operatorId,
                        service_id: serviceId,
                        start_date: startDate,
                        end_date: endDate,
                        report_type: reportType
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! Status: ${response.statusText}`);
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `report_${reportType}_${new Date().toISOString().slice(0,10)}.xlsx`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
                showNotification("–û—Ç—á–µ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!");
            } catch (error) {
                console.error("Error generating report:", error);
                showNotification(`${translations[currentLang].error_fetch} ${error.message}`, 'danger');
            }
        });

        // --- Analytics Tab ---
        async function updateAnalyticsDashboard() {
            try {
                const today = new Date().toISOString().slice(0, 10); //YYYY-MM-DD
                // Ensure this API route exists and returns data
                const response = await fetch(`${serverUrl}/api/admin_analytics?date=${today}`);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const data = await response.json();

                document.getElementById('totalTicketsTodayValue').innerText = data.total_tickets_today;
                document.getElementById('waitingTicketsValue').innerText = data.waiting_tickets;
                document.getElementById('calledTicketsValue').innerText = data.called_tickets;
                document.getElementById('finishedTicketsTodayValue').innerText = data.finished_tickets_today;

                // Update text for average wait and service times with localized labels
                document.getElementById('avgWaitTimeLabel').innerText = `${translations[currentLang].avgWaitTimeLabel} ${data.avg_wait_time !== null ? data.avg_wait_time.toFixed(2) + ' –º–∏–Ω.' : 'N/A'}`;
                document.getElementById('avgServiceTimeLabel').innerText = `${translations[currentLang].avgServiceTimeLabel} ${data.avg_service_time !== null ? data.avg_service_time.toFixed(2) + ' –º–∏–Ω.' : 'N/A'}`;
                
                // Update active tickets table
                const activeTicketsTableBody = document.getElementById('activeTicketsTableBody');
                activeTicketsTableBody.innerHTML = ''; // Clear previous data
                
                data.active_tickets.forEach(ticket => {
                    const row = activeTicketsTableBody.insertRow();
                    row.insertCell().innerText = ticket.ticket_number;
                    // Ensure status localization
                    row.insertCell().innerText = translations[currentLang][`ticket_status_${ticket.status}`] || ticket.status; 
                    row.insertCell().innerText = ticket.service_name;
                    row.insertCell().innerText = ticket.operator_name;
                    // Format times for display
                    row.insertCell().innerText = ticket.start_time ? new Date(ticket.start_time).toLocaleTimeString(currentLang.replace('_lat', '-Latn'), {hour: '2-digit', minute: '2-digit'}) : 'N/A';
                    row.insertCell().innerText = ticket.call_time ? new Date(ticket.call_time).toLocaleTimeString(currentLang.replace('_lat', '-Latn'), {hour: '2-digit', minute: '2-digit'}) : 'N/A';
                    row.insertCell().innerText = ticket.estimated_wait_time !== null ? `${ticket.estimated_wait_time} –º–∏–Ω.` : 'N/A';
                });

                // Update last updated time
                const now = new Date();
                const formattedTime = now.toLocaleTimeString(currentLang.replace('_lat', '-Latn'), {hour: '2-digit', minute: '2-digit', second: '2-digit'});
                document.getElementById('lastUpdatedTime').innerText = `${translations[currentLang].last_updated} ${formattedTime}`;

            } catch (error) {
                console.error("Error updating analytics dashboard:", error);
                showNotification(`${translations[currentLang].error_fetch} ${error.message}`, 'danger');
            }
        }


        function setLanguage(lang) {
            currentLang = lang;
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`button[onclick="setLanguage('${lang}')"]`).classList.add('active');
            
            // Update tab button texts
            document.getElementById('operatorsTab').innerText = translations[lang].operators_tab;
            document.getElementById('servicesTab').innerText = translations[lang].services_tab;
            document.getElementById('assignmentsTab').innerText = translations[lang].assignments_tab;
            document.getElementById('reportsTab').innerText = translations[lang].reports_tab;
            document.getElementById('analyticsTab').innerText = translations[lang].analytics_tab;
            document.querySelector('.logout-button').innerText = translations[lang].logout;


            // Update Operator tab
            document.getElementById('operatorListTitle').innerText = translations[lang].operatorListTitle;
            document.getElementById('labelOperatorName').innerText = translations[lang].labelOperatorName;
            document.getElementById('labelOperatorUsername').innerText = translations[lang].labelOperatorUsername;
            document.getElementById('labelOperatorPassword').innerText = translations[lang].labelOperatorPassword;
            document.getElementById('passwordHelpText').innerText = translations[lang].passwordHelpText;
            document.getElementById('labelOperatorNumber').innerText = translations[lang].labelOperatorNumber;
            document.getElementById('labelTelegramChatId').innerText = translations[lang].labelTelegramChatId;
            document.getElementById('labelNotificationPreference').innerText = translations[lang].labelNotificationPreference;
            document.getElementById('optPanel').innerText = translations[lang].optPanel;
            document.getElementById('optTelegram').innerText = translations[lang].optTelegram;
            document.getElementById('optBoth').innerText = translations[lang].optBoth;
            document.getElementById('optNone').innerText = translations[lang].optNone;
            document.getElementById('addOperatorBtn').innerText = document.getElementById('operatorId').value ? translations[lang].editOperatorBtn : translations[lang].addOperatorBtn;
            document.getElementById('cancelEditOperatorBtn').innerText = translations[lang].cancelEditOperatorBtn;
            document.getElementById('thOperatorName').innerText = translations[lang].thOperatorName;
            document.getElementById('thOperatorUsername').innerText = translations[lang].thOperatorUsername;
            document.getElementById('thOperatorNumber').innerText = translations[lang].thOperatorNumber;
            document.getElementById('thTelegramChatId').innerText = translations[lang].thTelegramChatId;
            document.getElementById('thNotificationPreference').innerText = translations[lang].thNotificationPreference;
            document.getElementById('thOperatorActions').innerText = translations[lang].thOperatorActions;

            // Update Services tab
            document.getElementById('serviceListTitle').innerText = translations[lang].serviceListTitle;
            document.getElementById('labelServiceName').innerText = translations[lang].labelServiceName;
            document.getElementById('labelParentService').innerText = translations[lang].labelParentService;
            document.getElementById('optNoParent').innerText = translations[lang].optNoParent;
            document.getElementById('labelIsService').innerText = translations[lang].labelIsService;
            document.getElementById('addServiceBtn').innerText = document.getElementById('serviceId').value ? translations[lang].editServiceBtn : translations[lang].addServiceBtn;
            document.getElementById('cancelEditServiceBtn').innerText = translations[lang].cancelEditServiceBtn;
            document.getElementById('thServiceListName').innerText = translations[lang].thServiceListName;
            document.getElementById('thServiceListParent').innerText = translations[lang].thServiceListParent;
            document.getElementById('thServiceListType').innerText = translations[lang].thServiceListType;
            document.getElementById('thServiceListActions').innerText = translations[lang].thServiceListActions;

            // Update Assignments tab
            document.getElementById('assignmentTitle').innerText = translations[lang].assignmentTitle;
            document.getElementById('labelAssignOperator').innerText = translations[lang].labelAssignOperator;
            document.getElementById('labelAssignedServices').innerText = translations[lang].labelAssignedServices;
            document.getElementById('saveAssignmentsBtn').innerText = translations[lang].saveAssignmentsBtn;

            // Update Reports tab
            document.getElementById('reportGenerationTitle').innerText = translations[lang].reportGenerationTitle;
            document.getElementById('labelReportOperator').innerText = translations[lang].labelReportOperator;
            document.getElementById('optAllOperators').innerText = translations[lang].optAllOperators;
            document.getElementById('labelReportService').innerText = translations[lang].labelReportService;
            document.getElementById('optAllServices').innerText = translations[lang].optAllServices;
            document.getElementById('labelStartDate').innerText = translations[lang].labelStartDate;
            document.getElementById('labelEndDate').innerText = translations[lang].labelEndDate;
            document.getElementById('labelReportType').innerText = translations[lang].labelReportType;
            document.getElementById('optDetailed').innerText = translations[lang].optDetailed;
            document.getElementById('optSummary').innerText = translations[lang].optSummary;
            document.getElementById('optOperatorPerformance').innerText = translations[lang].optOperatorPerformance;
            document.getElementById('optServicePerformance').innerText = translations[lang].optServicePerformance;
            document.getElementById('generateReportBtn').innerText = translations[lang].generateReportBtn;

            // Update Analytics tab
            document.getElementById('analyticsDashboardTitle').innerText = translations[lang].analyticsDashboardTitle;
            document.getElementById('totalTicketsTodayLabel').innerText = translations[lang].totalTicketsTodayLabel;
            document.getElementById('waitingTicketsLabel').innerText = translations[lang].waitingTicketsLabel;
            document.getElementById('avgWaitTimeLabel').innerText = translations[lang].avgWaitTimeLabel; // Will be updated by updateAnalyticsDashboard
            document.getElementById('calledTicketsLabel').innerText = translations[lang].calledTicketsLabel;
            document.getElementById('finishedTicketsTodayLabel').innerText = translations[lang].finishedTicketsTodayLabel;
            document.getElementById('avgServiceTimeLabel').innerText = translations[lang].avgServiceTimeLabel; // Will be updated by updateAnalyticsDashboard
            document.getElementById('currentQueueListTitle').innerText = translations[lang].currentQueueListTitle;
            document.getElementById('thAnalyticsTicketNumber').innerText = translations[lang].thAnalyticsTicketNumber;
            document.getElementById('thAnalyticsStatus').innerText = translations[lang].thAnalyticsStatus;
            document.getElementById('thAnalyticsService').innerText = translations[lang].thAnalyticsService;
            document.getElementById('thAnalyticsOperator').innerText = translations[lang].thAnalyticsOperator;
            document.getElementById('thAnalyticsStartTime').innerText = translations[lang].thAnalyticsStartTime;
            document.getElementById('thAnalyticsCallTime').innerText = translations[lang].thAnalyticsCallTime;
            document.getElementById('thAnalyticsEstimatedWait').innerText = translations[lang].thAnalyticsEstimatedWait;
            document.getElementById('lastUpdatedTime').innerText = translations[lang].last_updated; // Will be updated by updateAnalyticsDashboard

            // –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–∫–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –∏ —É—Å–ª—É–≥ –≤ —Ñ–æ—Ä–º–∞—Ö –æ—Ç—á–µ—Ç–æ–≤ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            if (currentTab === 'operators') loadOperators();
            if (currentTab === 'services') loadServices();
            if (currentTab === 'assignments') {
                loadOperatorsForAssignments();
                loadServicesForAssignments();
                loadAssignedServices(); // Reload assigned services for selected operator
            }
            if (currentTab === 'reports') {
                fetchOperatorsForReports();
                fetchServicesForReports();
            }
            if (currentTab === 'analytics') {
                updateAnalyticsDashboard();
            }
        }

        function toggleTheme() {
            document.body.classList.toggle('dark');
            const isDark = document.body.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            document.querySelector('.theme-toggle').innerText = isDark ? '‚òÄÔ∏è' : 'üåô';
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        if (localStorage.getItem("theme") === "dark") {
            document.body.classList.add("dark");
            document.querySelector(".theme-toggle").innerText = "‚òÄÔ∏è";
        }
        setLanguage("uz_lat"); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —è–∑—ã–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        openTab('operators'); // –û—Ç–∫—Ä—ã–≤–∞–µ–º –≤–∫–ª–∞–¥–∫—É "–û–ø–µ—Ä–∞—Ç–æ—Ä—ã" –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

        // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤–∫–ª–∞–¥–æ–∫
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                openTab(button.dataset.tab);
            });
        });

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
        setInterval(updateAnalyticsDashboard, 10000);

        // Socket.IO –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ (–ø—Ä–∏–º–µ—Ä)
        socket.on('new_ticket', (data) => {
            console.log("–ù–æ–≤—ã–π —Ç–∞–ª–æ–Ω –¥–æ–±–∞–≤–ª–µ–Ω:", data.number);
            if (currentTab === 'analytics') {
                updateAnalyticsDashboard();
            }
        });

        socket.on('ticket_called', (data) => {
            console.log("–¢–∞–ª–æ–Ω –≤—ã–∑–≤–∞–Ω:", data.ticket);
            if (currentTab === 'analytics') {
                updateAnalyticsDashboard();
            }
        });

        socket.on('ticket_finished', (data) => {
            console.log("–¢–∞–ª–æ–Ω –∑–∞–≤–µ—Ä—à–µ–Ω:", data.ticket);
            if (currentTab === 'analytics') {
                updateAnalyticsDashboard();
            }
        });

        socket.on('ticket_redirected', (data) => {
            console.log("–¢–∞–ª–æ–Ω –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω:", data.ticket);
            if (currentTab === 'analytics') {
                updateAnalyticsDashboard();
            }
        });

        socket.on('new_feedback', () => {
            console.log("–ù–æ–≤—ã–π –æ—Ç–∑—ã–≤ –¥–æ–±–∞–≤–ª–µ–Ω.");
            if (currentTab === 'analytics') { // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–∏–º –∞–Ω–∞–ª–∏—Ç–∏–∫—É, –µ—Å–ª–∏ —Ç–∞–º –µ—Å—Ç—å —Å—á–µ—Ç—á–∏–∫–∏ –æ—Ç–∑—ã–≤–æ–≤
                updateAnalyticsDashboard();
            }
        });

        socket.on('new_dispute', () => {
            console.log("–ù–æ–≤–∞—è –∂–∞–ª–æ–±–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞.");
            if (currentTab === 'analytics') { // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–∏–º –∞–Ω–∞–ª–∏—Ç–∏–∫—É, –µ—Å–ª–∏ —Ç–∞–º –µ—Å—Ç—å —Å—á–µ—Ç—á–∏–∫–∏ –∂–∞–ª–æ–±
                updateAnalyticsDashboard();
            }
        });

    </script>
</body>
</html>
